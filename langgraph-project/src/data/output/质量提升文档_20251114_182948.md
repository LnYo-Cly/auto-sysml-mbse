# 无人机系统设计文档

## 1. 需求规格

### 功能性需求

**REQ-FUN-001: 自主飞行控制**
*   **背景与上下文**: 无人机需要能够在无人直接操控的情况下，按照预设航线完成飞行任务，这对于农业测绘、物流配送等应用至关重要。
*   **详细描述**: 系统应能接收地面控制站发送的飞行计划（包含航点坐标、高度、速度），通过GPS/IMU传感器融合确定自身位置和姿态，并驱动电机和舵机实现自主导航飞行。支持RTK-GPS定位，水平定位精度达到±1cm+1ppm，垂直定位精度±1.5cm+1ppm。飞行控制频率不低于200Hz，姿态控制精度优于0.1°。
*   **理由**: 实现自动化作业，减少人工干预，提高任务执行效率和精度。
*   **验证方法**: 基于DO-178C的单元测试和集成测试，MIL/SIL/PIL验证流程
*   **验收标准**: 航点跟踪误差<0.5m，高度保持误差<0.2m，速度控制误差<0.1m/s
*   **优先级**: High

**REQ-FUN-002: 实时视频传输**
*   **背景与上下文**: 操作员需要实时观察无人机拍摄的画面，用于监控任务执行情况或进行手动操控。
*   **详细描述**: 机载摄像头采集1080p@30fps视频流，通过H.264编码后，经由5.8GHz图传系统以<100ms端到端延迟发送至地面站显示。支持自适应码率控制，码率范围2-10Mbps可调。视频传输采用FEC前向纠错和ARQ自动重传机制，确保在20%丢包率下仍可正常解码。
*   **理由**: 提供第一人称视角，支持远程监控和决策。
*   **验证方法**: 基于RFC 3550的RTP流媒体性能测试
*   **验收标准**: 视频延迟<100ms，解码成功率>99.5%，PSNR>35dB
*   **优先级**: High

**REQ-FUN-003: 智能电池管理**
*   **背景与上下文**: 为确保飞行安全和延长电池寿命，系统需要精确监控和管理电池状态。
*   **详细描述**: 实时监测6S锂聚合物电池的电压、电流、温度和剩余电量，采样频率1kHz，电压测量精度±5mV，电流测量精度±10mA。当电量低于20%或单体电压低于3.3V时自动触发返航，低于15%强制着陆。支持电池健康状态(SOH)估算，精度±3%。
*   **理由**: 防止因电量耗尽导致的坠机事故，保护电池健康。
*   **验证方法**: 基于IEC 62660标准的电池性能测试
*   **验收标准**: SOC估算误差<3%，过压/欠压保护响应时间<100ms
*   **优先级**: High

**REQ-FUN-004: 避障与应急处理**
*   **背景与上下文**: 在复杂环境中飞行时，无人机需要能够感知并规避障碍物，确保飞行安全。
*   **详细描述**: 通过前向和下视TOF传感器检测5米范围内的障碍物，检测角度水平±75°，垂直±60°，检测精度±2cm。当检测到障碍物时，自动悬停或规划绕行路径。避障决策周期<50ms，支持动态障碍物跟踪和预测。
*   **理由**: 提升飞行安全性，减少碰撞风险。
*   **验证方法**: 基于ISO 26262的功能安全测试
*   **验收标准**: 避障成功率>99.9%，误报率<0.1%，响应时间<100ms
*   **优先级**: Medium

### 非功能性需求

**REQ-NFN-001: 飞行性能**
*   **背景与上下文**: 飞行性能直接影响无人机的任务执行能力和适用场景。
*   **详细描述**: 最大水平飞行速度15m/s，最大续航时间30分钟，最大抗风能力10m/s，最大作业海拔4000米。悬停精度：垂直±0.1m，水平±0.3m。最大爬升率5m/s，最大下降率3m/s。
*   **理由**: 确保无人机能够在典型任务环境中稳定可靠地工作。
*   **验证方法**: 基于ASTM F3178标准的飞行性能测试
*   **验收标准**: 所有性能指标在95%置信区间内满足要求
*   **优先级**: High

**REQ-NFN-002: 通信可靠性**
*   **背景与上下文**: 可靠的通信链路是无人机安全操控和数据传输的基础。
*   **详细描述**: 遥控链路使用2.4GHz频段，控制距离≥2km，丢包率<1%，采用DSSS扩频技术。图传链路使用5.8GHz，传输距离≥1km，延迟<100ms，支持MIMO 2x2。通信系统具备自动频点切换和功率控制功能。
*   **理由**: 保证在典型作业距离内控制指令和视频数据的可靠传输。
*   **验证方法**: 基于ETSI EN 300 328标准的无线性能测试
*   **验收标准**: 控制链路BER<10⁻⁶，图传链路PER<10⁻³
*   **优先级**: High

**REQ-NFN-003: 环境适应性**
*   **背景与上下文**: 无人机需要在各种气候条件下正常工作。
*   **详细描述**: 工作温度范围-10°C至+40°C，存储温度-20°C至+60°C，防护等级IP43，能够在小雨（降雨量<2.5mm/h）和中等湿度（<85%RH）环境下短时工作。抗振动等级：5-500Hz，1.5Grms。
*   **理由**: 扩展无人机的适用场景和地域范围。
*   **验证方法**: 基于MIL-STD-810H的环境适应性测试
*   **验收标准**: 在极限环境下功能正常，性能下降不超过10%
*   **优先级**: Medium

**REQ-NFN-004: 系统可靠性**
*   **背景与上下文**: 高可靠性是无人机安全飞行的基本要求。
*   **详细描述**: 平均无故障时间(MTBF) ≥ 1000小时，平均修复时间(MTTR) ≤ 30分钟。关键系统（如飞控）采用双冗余设计，传感器采用三冗余投票机制。系统可用性≥99.9%。
*   **理由**: 减少系统故障概率，提升飞行安全性。
*   **验证方法**: 基于IEC 61508的可靠性分析和FMEA
*   **验收标准**: 在95%置信水平下满足可靠性指标
*   **优先级**: High

## 2. 系统结构

### 系统顶层架构设计理念
本系统采用分层模块化架构，遵循ARINC 653分区化设计原则，将功能按层次划分为感知层、决策层、执行层和通信层。系统基于时间触发架构(TTA)，确保硬实时性能。采用FACE技术标准定义组件接口，支持模块化升级和功能扩展。主要功能块基于无人机典型子系统划分，确保每个模块职责明确，接口清晰。

### 块定义

**FlightController**
*   **概述**: 作为无人机的大脑，飞行控制器负责处理所有传感器数据，运行控制算法，并生成电机控制指令。采用双冗余设计确保可靠性，通过高速串行总线与各子系统通信。基于ARM Cortex-M7和Cortex-M4异构架构，主频400MHz，配备2MB Flash和1MB RAM。
*   **核心职责**: 
    *   运行姿态解算和导航算法
    *   处理用户控制指令
    *   执行飞行模式管理
    *   协调各子系统工作
*   **关键属性**: 
    *   - processorLoad: Real [%] {0..100} = 65
    *   - controlFrequency: Integer [Hz] {100..500} = 200
    *   - operationMode: FlightMode {MANUAL, GPS, AUTO, RTL, LOITER} = AUTO
    *   - navigationAccuracy: Real [m] = 0.5
    *   - attitudeAccuracy: Real [°] = 0.1
*   **核心操作**: 
    *   - calculateAttitude(imuData: IMUData): Attitude
    *   - executeNavigation(waypoints: Waypoint[]): NavigationStatus
    *   - setFlightMode(mode: FlightMode): Boolean
    *   - monitorSystemHealth(): HealthStatus
    *   - handleFault(fault: FaultCode): RecoveryAction

**PowerManagementUnit**
*   **概述**: 电源管理单元负责整个系统的供电分配和电池状态监控，采用智能功率分配策略确保关键系统优先供电，并通过CAN总线实时上报电池状态。基于TI BQ40Z50芯片，支持SMBus通信协议。
*   **核心职责**: 
    *   监控电池参数
    *   管理电源分配
    *   执行低电量保护
    *   控制充电过程
*   **关键属性**: 
    *   - batteryCapacity: Real [mAh] {0..10000} = 6000
    *   - remainingPower: Real [%] {0..100} = 85
    *   - dischargeRate: Real [C] {0..5} = 2.5
    *   - batteryTemperature: Real [°C] {-20..60} = 25
    *   - cycleCount: Integer {0..1000} = 50
*   **核心操作**: 
    *   - monitorBattery(): BatteryStatus
    *   - distributePower(load: PowerLoad): Boolean
    *   - enableLowPowerProtection(): Void
    *   - calculateRemainingTime(): Real
    *   - balanceCells(): BalanceStatus

**SensorFusionModule**
*   **概述**: 传感器融合模块集成多源传感器数据，通过扩展卡尔曼滤波(EKF)算法提供精确的位置、速度和姿态信息，为飞行控制提供可靠的感知输入。支持GPS、IMU、磁力计、气压计等多传感器数据融合。
*   **核心职责**: 
    *   采集IMU数据
    *   处理GPS定位信息
    *   融合多传感器数据
    *   提供障碍物检测
*   **关键属性**: 
    *   - positionAccuracy: Real [m] {0.1..5.0} = 1.0
    *   - updateRate: Integer [Hz] {50..200} = 100
    *   - sensorHealth: SensorHealthStatus {OK, DEGRADED, FAILED} = OK
    *   - fusionAlgorithm: AlgorithmType {EKF, UKF, Complementary} = EKF
    *   - calibrationStatus: CalibrationState {UNCALIBRATED, CALIBRATING, CALIBRATED} = CALIBRATED
*   **核心操作**: 
    *   - fuseSensorData(): NavigationData
    *   - calibrateSensors(): CalibrationStatus
    *   - detectObstacles(): ObstacleInfo[]
    *   - estimatePositionUncertainty(): CovarianceMatrix
    *   - validateSensorData(): ValidationResult

**CommunicationSystem**
*   **概述**: 通信系统负责无人机与地面站之间的双向数据交换，采用多频段设计避免干扰，具备链路质量监测和自动频点切换功能。基于SiK无线电协议，支持MAVLink消息传输。
*   **核心职责**: 
    *   传输控制指令
    *   发送遥测数据
    *   传输视频流
    *   管理通信链路
*   **关键属性**: 
    *   - linkQuality: Real [%] {0..100} = 95
    *   - signalStrength: Real [dBm] {-120..0} = -65
    *   - dataRate: Real [Mbps] {1..50} = 10
    *   - packetLoss: Real [%] {0..100} = 0.5
    *   - retryCount: Integer {0..10} = 3
*   **核心操作**: 
    *   - transmitTelemetry(data: TelemetryData): Boolean
    *   - receiveCommand(): ControlCommand
    *   - manageLinkQuality(): LinkStatus
    *   - switchFrequency(channel: Integer): Boolean
    *   - encryptData(data: Byte[]): EncryptedData

**PropulsionSystem**
*   **概述**: 推进系统包含电机和电子调速器，负责将控制指令转化为实际的推力和力矩，采用闭环控制确保转速精度和响应速度。基于BLDC无刷电机和32位ESC电调，支持DShot数字协议。
*   **核心职责**: 
    *   驱动无刷电机
    *   调节电机转速
    *   提供飞行推力
    *   监控电机状态
*   **关键属性**: 
    *   - motorRPM: Integer [RPM] {0..20000} = 8500
    *   - thrustOutput: Real [N] {0..50} = 12.5
    *   - motorTemperature: Real [°C] {-40..120} = 45
    *   - efficiency: Real [%] {0..100} = 85
    *   - vibrationLevel: Real [g] {0..10} = 0.8
*   **核心操作**: 
    *   - setMotorSpeed(rpm: Integer): Boolean
    *   - monitorMotorHealth(): MotorStatus
    *   - emergencyStop(): Void
    *   - calibrateESC(): CalibrationResult
    *   - synchronizeMotors(): SyncStatus

### 内部结构与交互原理

**上下文**: FlightController
*   **设计阐述**: 飞行控制器内部采用主从式架构，主处理器运行核心控制算法，协处理器处理传感器数据预处理和通信协议栈。基于AMP非对称多处理架构，主处理器运行实时操作系统，协处理器运行裸机程序。采用双CAN总线冗余设计，确保通信可靠性。
*   **组成部分**: 
    *   mainProcessor: ARM Cortex-M7 @ 400MHz
    *   sensorProcessor: ARM Cortex-M4 @ 200MHz
    *   memoryModule: FlashMemory 2MB + SRAM 1MB
    *   interfaceController: CommunicationInterface (双CAN, 4xUART, 2xSPI, I2C)
    *   watchdogTimer: IndependentWatchdog 32-bit
*   **连接关系**: 
    *   [mainProcessor.spi1] <--> [sensorProcessor.spi1] (数据交换, 10Mbps)
    *   [mainProcessor.uart1] <--> [interfaceController.uart1] (调试输出, 115200bps)
    *   [sensorProcessor.i2c1] <--> [memoryModule.i2c] (配置存储, 400kHz)
    *   [mainProcessor.can1] <--> [interfaceController.can1] (主通信总线, 1Mbps)
    *   [mainProcessor.can2] <--> [interfaceController.can2] (备份通信总线, 1Mbps)

**上下文**: PowerManagementUnit
*   **设计阐述**: 电源管理单元采用分布式供电架构，核心处理器和关键传感器享有独立供电线路，确保在电源波动时关键系统不受影响。基于PMBus电源管理总线，支持动态电压调节和功率限制。配备超级电容作为瞬时功率补偿。
*   **组成部分**: 
    *   batteryMonitor: TI BQ40Z50 (6S电池管理)
    *   powerDistributor: PowerDistributionBoard (8路输出)
    *   voltageRegulator: SwitchingRegulator (效率>95%)
    *   protectionCircuit: OvercurrentProtection (响应时间<10μs)
    *   backupCapacitor: SuperCapacitor 10F @ 16V
*   **连接关系**: 
    *   [batteryMonitor.analog] <--> [powerDistributor.sense] (电压电流采样)
    *   [powerDistributor.power] <--> [voltageRegulator.input] (电源输入)
    *   [voltageRegulator.output] <--> [protectionCircuit.input] (稳压输出)
    *   [protectionCircuit.output] <--> [backupCapacitor.terminal] (备份电源)
    *   [batteryMonitor.smbus] <--> [powerDistributor.smbus] (数字通信)

## 3. 活动流程

**活动名称**: 自主航线飞行流程
*   **流程概述**: 此流程描述了无人机从接收飞行任务到完成航线飞行的完整过程，包括任务验证、起飞、航点导航、数据采集和着陆等关键阶段。采用有限状态机模式管理流程状态转换，确保任务执行的规范性和安全性。
*   **输入/输出**: IN: flight_mission: MissionPlan, OUT: mission_report: MissionReport
*   **前置条件**: 系统已完成初始化自检，电池电量>30%，GPS定位有效，无严重故障
*   **后置条件**: 无人机安全着陆，任务数据完整保存，系统返回待机状态
*   **步骤序列**: 
    1.  接收并验证飞行任务数据（完整性检查、安全性评估）
    2.  执行起飞前自检程序（传感器校准、电机测试、通信链路验证）
    3.  自动起飞至预设高度（爬升率2m/s，姿态稳定控制）
    4.  按顺序导航至各航点（L1导航算法，前视距离调整）
    5.  在航点执行任务载荷操作（相机触发、传感器数据采集）
    6.  实时监控飞行状态和环境条件（电池状态、障碍物检测、气象条件）
    7.  在最后一个航点启动返航程序（RTL模式激活）
    8.  执行自动着陆序列（下降率1m/s，地面效应补偿）
    9.  生成任务执行报告（飞行数据统计、异常事件记录）

**活动名称**: 应急处理流程
*   **流程概述**: 当系统检测到异常情况时，此流程确保无人机能够安全应对。基于ISO 26262功能安全标准设计，采用分级响应机制，包括故障诊断、模式切换和安全策略执行，最大限度保障人员和设备安全。
*   **输入/输出**: IN: fault_detection: FaultSignal, OUT: emergency_status: EmergencyStatus
*   **前置条件**: 系统处于飞行状态，故障检测系统正常运行
*   **后置条件**: 无人机进入安全状态，故障信息记录完整，操作员已通知
*   **步骤序列**: 
    1.  接收故障检测信号（