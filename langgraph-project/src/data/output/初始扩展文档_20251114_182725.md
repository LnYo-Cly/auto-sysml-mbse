# 无人机系统设计文档

## 1. 需求规格

### 功能性需求

**REQ-FUN-001: 自主飞行控制**
*   **背景与上下文**: 无人机需要能够在无人直接操控的情况下，按照预设航线完成飞行任务，这对于农业测绘、物流配送等应用至关重要。
*   **详细描述**: 系统应能接收地面控制站发送的飞行计划（包含航点坐标、高度、速度），通过GPS/IMU传感器融合确定自身位置和姿态，并驱动电机和舵机实现自主导航飞行。
*   **理由**: 实现自动化作业，减少人工干预，提高任务执行效率和精度。
*   **验证方法**: Test
*   **优先级**: High

**REQ-FUN-002: 实时视频传输**
*   **背景与上下文**: 操作员需要实时观察无人机拍摄的画面，用于监控任务执行情况或进行手动操控。
*   **详细描述**: 机载摄像头采集1080p@30fps视频流，通过H.264编码后，经由5.8GHz图传系统以<100ms延迟发送至地面站显示。
*   **理由**: 提供第一人称视角，支持远程监控和决策。
*   **验证方法**: Demonstration
*   **优先级**: High

**REQ-FUN-003: 智能电池管理**
*   **背景与上下文**: 为确保飞行安全和延长电池寿命，系统需要精确监控和管理电池状态。
*   **详细描述**: 实时监测6S锂聚合物电池的电压、电流、温度和剩余电量，当电量低于20%或电压低于3.3V/单体时自动触发返航。
*   **理由**: 防止因电量耗尽导致的坠机事故，保护电池健康。
*   **验证方法**: Test
*   **优先级**: High

**REQ-FUN-004: 避障与应急处理**
*   **背景与上下文**: 在复杂环境中飞行时，无人机需要能够感知并规避障碍物，确保飞行安全。
*   **详细描述**: 通过前向和下视TOF传感器检测5米范围内的障碍物，当检测到障碍物时，自动悬停或规划绕行路径。
*   **理由**: 提升飞行安全性，减少碰撞风险。
*   **验证方法**: Test
*   **优先级**: Medium

### 非功能性需求

**REQ-NFN-001: 飞行性能**
*   **背景与上下文**: 飞行性能直接影响无人机的任务执行能力和适用场景。
*   **详细描述**: 最大水平飞行速度15m/s，最大续航时间30分钟，最大抗风能力10m/s，最大作业海拔4000米。
*   **理由**: 确保无人机能够在典型任务环境中稳定可靠地工作。
*   **验证方法**: Test
*   **优先级**: High

**REQ-NFN-002: 通信可靠性**
*   **背景与上下文**: 可靠的通信链路是无人机安全操控和数据传输的基础。
*   **详细描述**: 遥控链路使用2.4GHz频段，控制距离≥2km，丢包率<1%；图传链路使用5.8GHz，传输距离≥1km，延迟<100ms。
*   **理由**: 保证在典型作业距离内控制指令和视频数据的可靠传输。
*   **验证方法**: Test
*   **优先级**: High

**REQ-NFN-003: 环境适应性**
*   **背景与上下文**: 无人机需要在各种气候条件下正常工作。
*   **详细描述**: 工作温度范围-10°C至+40°C，防护等级IP43，能够在小雨和中等湿度环境下短时工作。
*   **理由**: 扩展无人机的适用场景和地域范围。
*   **验证方法**: Test
*   **优先级**: Medium

**REQ-NFN-004: 系统可靠性**
*   **背景与上下文**: 高可靠性是无人机安全飞行的基本要求。
*   **详细描述**: 平均无故障时间(MTBF) ≥ 1000小时，关键系统（如飞控）采用冗余设计。
*   **理由**: 减少系统故障概率，提升飞行安全性。
*   **验证方法**: Analysis
*   **优先级**: High

## 2. 系统结构

### 系统顶层架构设计理念
本系统采用分层模块化架构，将功能按层次划分，包括感知层、决策层、执行层和通信层。这种设计确保了高内聚低耦合，便于系统维护和功能扩展。主要功能块基于无人机典型子系统划分，确保每个模块职责明确，接口清晰。

### 块定义

**FlightController**
*   **概述**: 作为无人机的大脑，飞行控制器负责处理所有传感器数据，运行控制算法，并生成电机控制指令。它采用双冗余设计确保可靠性，通过高速串行总线与各子系统通信。
*   **核心职责**: 
    *   运行姿态解算和导航算法
    *   处理用户控制指令
    *   执行飞行模式管理
    *   协调各子系统工作
*   **关键属性**: 
    *   - processorLoad: Real [%] {0..100}
    *   - controlFrequency: Integer [Hz] {100..500}
    *   - operationMode: FlightMode {MANUAL, GPS, AUTO}
*   **核心操作**: 
    *   - calculateAttitude(imuData: IMUData): Attitude
    *   - executeNavigation(waypoints: Waypoint[]): NavigationStatus
    *   - setFlightMode(mode: FlightMode): Boolean

**PowerManagementUnit**
*   **概述**: 电源管理单元负责整个系统的供电分配和电池状态监控，采用智能功率分配策略确保关键系统优先供电，并通过CAN总线实时上报电池状态。
*   **核心职责**: 
    *   监控电池参数
    *   管理电源分配
    *   执行低电量保护
    *   控制充电过程
*   **关键属性**: 
    *   - batteryCapacity: Real [mAh] {0..10000}
    *   - remainingPower: Real [%] {0..100}
    *   - dischargeRate: Real [C] {0..5}
*   **核心操作**: 
    *   - monitorBattery(): BatteryStatus
    *   - distributePower(load: PowerLoad): Boolean
    *   - enableLowPowerProtection(): Void

**SensorFusionModule**
*   **概述**: 传感器融合模块集成多源传感器数据，通过卡尔曼滤波算法提供精确的位置、速度和姿态信息，为飞行控制提供可靠的感知输入。
*   **核心职责**: 
    *   采集IMU数据
    *   处理GPS定位信息
    *   融合多传感器数据
    *   提供障碍物检测
*   **关键属性**: 
    *   - positionAccuracy: Real [m] {0.1..5.0}
    *   - updateRate: Integer [Hz] {50..200}
    *   - sensorHealth: SensorHealthStatus {OK, DEGRADED, FAILED}
*   **核心操作**: 
    *   - fuseSensorData(): NavigationData
    *   - calibrateSensors(): CalibrationStatus
    *   - detectObstacles(): ObstacleInfo[]

**CommunicationSystem**
*   **概述**: 通信系统负责无人机与地面站之间的双向数据交换，采用多频段设计避免干扰，具备链路质量监测和自动频点切换功能。
*   **核心职责**: 
    *   传输控制指令
    *   发送遥测数据
    *   传输视频流
    *   管理通信链路
*   **关键属性**: 
    *   - linkQuality: Real [%] {0..100}
    *   - signalStrength: Real [dBm] {-120..0}
    *   - dataRate: Real [Mbps] {1..50}
*   **核心操作**: 
    *   - transmitTelemetry(data: TelemetryData): Boolean
    *   - receiveCommand(): ControlCommand
    *   - manageLinkQuality(): LinkStatus

**PropulsionSystem**
*   **概述**: 推进系统包含电机和电子调速器，负责将控制指令转化为实际的推力和力矩，采用闭环控制确保转速精度和响应速度。
*   **核心职责**: 
    *   驱动无刷电机
    *   调节电机转速
    *   提供飞行推力
    *   监控电机状态
*   **关键属性**: 
    *   - motorRPM: Integer [RPM] {0..20000}
    *   - thrustOutput: Real [N] {0..50}
    *   - motorTemperature: Real [°C] {-40..120}
*   **核心操作**: 
    *   - setMotorSpeed(rpm: Integer): Boolean
    *   - monitorMotorHealth(): MotorStatus
    *   - emergencyStop(): Void

### 内部结构与交互原理

**上下文**: FlightController
*   **设计阐述**: 飞行控制器内部采用主从式架构，主处理器运行核心控制算法，协处理器处理传感器数据预处理和通信协议栈。这种设计平衡了计算负载，确保了实时性要求。
*   **组成部分**: 
    *   mainProcessor: ARM Cortex-M7
    *   sensorProcessor: ARM Cortex-M4
    *   memoryModule: FlashMemory
    *   interfaceController: CommunicationInterface
*   **连接关系**: 
    *   [mainProcessor.spi] <--> [sensorProcessor.spi]
    *   [mainProcessor.uart] <--> [interfaceController.uart]
    *   [sensorProcessor.i2c] <--> [memoryModule.i2c]

**上下文**: PowerManagementUnit
*   **设计阐述**: 电源管理单元采用分布式供电架构，核心处理器和关键传感器享有独立供电线路，确保在电源波动时关键系统不受影响。
*   **组成部分**: 
    *   batteryMonitor: BatteryMonitorIC
    *   powerDistributor: PowerDistributionBoard
    *   voltageRegulator: SwitchingRegulator
    *   protectionCircuit: OvercurrentProtection
*   **连接关系**: 
    *   [batteryMonitor.analog] <--> [powerDistributor.sense]
    *   [powerDistributor.power] <--> [voltageRegulator.input]
    *   [voltageRegulator.output] <--> [protectionCircuit.input]

## 3. 活动流程

**活动名称**: 自主航线飞行流程
*   **流程概述**: 此流程描述了无人机从接收飞行任务到完成航线飞行的完整过程，包括任务验证、起飞、航点导航、数据采集和着陆等关键阶段，确保任务执行的规范性和安全性。
*   **输入/输出**: IN: flight_mission: MissionPlan, OUT: mission_report: MissionReport
*   **步骤序列**: 
    1.  接收并验证飞行任务数据
    2.  执行起飞前自检程序
    3.  自动起飞至预设高度
    4.  按顺序导航至各航点
    5.  在航点执行任务载荷操作
    6.  实时监控飞行状态和环境条件
    7.  在最后一个航点启动返航程序
    8.  执行自动着陆序列
    9.  生成任务执行报告

**活动名称**: 应急处理流程
*   **流程概述**: 当系统检测到异常情况时，此流程确保无人机能够安全应对，包括故障诊断、模式切换和安全策略执行，最大限度保障人员和设备安全。
*   **输入/输出**: IN: fault_detection: FaultSignal, OUT: emergency_status: EmergencyStatus
*   **步骤序列**: 
    1.  接收故障检测信号
    2.  诊断故障类型和严重程度
    3.  根据故障等级选择应对策略
    4.  执行模式切换（如切换到悬停或返航）
    5.  通知地面站故障信息
    6.  监控应急措施执行效果
    7.  记录故障处理过程

## 4. 状态机行为

**上下文块**: FlightController
*   **行为模型概述**: 飞行控制器的状态机定义了无人机从关机到任务完成的完整生命周期，每个状态代表不同的运行模式和系统配置，状态转换由用户指令、系统事件和传感器数据共同驱动。

**状态定义**:

**状态名称**: POWER_OFF
*   **描述**: 系统完全断电状态，所有电子设备不工作
*   `entry / 关闭所有外围设备电源`
*   `do / 无持续活动`
*   `exit / 初始化电源管理单元`

**状态名称**: INITIALIZING
*   **描述**: 系统上电后的初始化状态，进行硬件自检和软件加载
*   `entry / 启动 bootloader，加载操作系统`
*   `do / 执行硬件自检程序，校准传感器`
*   `exit / 生成系统就绪信号`

**状态名称**: STANDBY
*   **描述**: 系统就绪等待指令状态，所有子系统正常运行但未执行飞行任务
*   `entry / 启动所有传感器数据采集`
*   `do / 监控用户输入，维持系统健康状态`
*   `exit / 准备接收飞行指令`

**状态名称**: TAKEOFF
*   **描述**: 自动起飞过程，无人机从地面升至预设高度
*   `entry / 解锁电机，设置起飞推力`
*   `do / 执行垂直爬升控制，维持姿态稳定`
*   `exit / 达到目标高度，转入悬停`

**状态名称**: NAVIGATING
*   **描述**: 航线导航状态，按照预设路径飞行
*   `entry / 加载航线数据，启动导航算法`
*   `do / 执行位置和姿态控制，跟踪航点`
*   `exit / 到达最终航点或收到中止指令`

**状态名称**: LANDING
*   **描述**: 自动着陆过程，安全返回地面
*   `entry / 启动着陆程序，降低高度`
*   `do / 执行精确高度控制，维持稳定下降`
*   `exit / 检测到着陆接触，关闭电机`

**状态名称**: EMERGENCY
*   **描述**: 紧急处理状态，响应系统故障或异常情况
*   `entry / 触发警报，记录故障信息`
*   `do / 执行应急控制策略，维持基本稳定`
*   `exit / 故障排除或安全着陆完成`

**转换**:
*   `POWER_OFF --[power_button_pressed]--> INITIALIZING`
*   `INITIALIZING --[self_test_passed]--> STANDBY`
*   `STANDBY --[takeoff_command_received]--> TAKEOFF`
*   `TAKEOFF --[target_altitude_reached]--> NAVIGATING`
*   `NAVIGATING --[final_waypoint_reached]--> LANDING`
*   `NAVIGATING --[fault_detected]--> EMERGENCY`
*   `LANDING --[ground_contact_detected]--> STANDBY`
*   `EMERGENCY --[fault_resolved]--> STANDBY`

## 5. 用例场景

**用例名称**: 执行测绘任务
*   **场景简述**: 测绘工程师需要获取某区域的高精度地图数据，他通过地面站软件规划测绘航线，上传至无人机后启动自动飞行任务，无人机按照预设路径飞行并采集图像数据。
*   **参与者**: Primary: 测绘工程师, Secondary: 地面控制站
*   **基本流程**: 
    1.  工程师在地面站软件中规划测绘区域和飞行参数
    2.  系统验证航线安全性并生成飞行计划
    3.  工程师确认计划并上传至无人机
    4.  无人机执行自主起飞和航线跟踪
    5.  在飞行过程中持续采集图像数据
    6.  完成任务后自动返航着陆
    7.  工程师下载采集的数据用于后续处理
*   **备选/异常流程**: 
    *   如遇恶劣天气，系统提示风险并建议修改计划
    *   如电池电量不足，自动启动返航程序
    *   如通信中断，执行预设应急策略

**用例名称**: 手动遥控飞行
*   **场景简述**: 操作员通过遥控器直接控制无人机飞行，用于特殊情况下的精确操控或应急处理。
*   **参与者**: Primary: 无人机操作员, Secondary: 遥控器
*   **基本流程**: 
    1.  操作员切换至手动飞行模式
    2.  通过遥控器摇杆发送控制指令
    3.  无人机实时响应操控指令
    4.  操作员通过视频回传监控飞行状态
    5.  完成任务后切换回自动模式着陆
*   **备选/异常流程**: 
    *   如信号干扰严重，系统自动增强信号处理
    *   如操作员指令超出安全范围，系统限制执行
    *   如检测到操作员失误，启动辅助稳定

## 6. 参数关系

**约束块**: 飞行续航时间计算
*   **物理意义与应用**: 此公式基于电池容量、系统功耗和飞行条件计算理论续航时间，用于任务规划和性能评估。
*   **参数**: 
    *   T: 续航时间 (分钟)
    *   C: 电池容量 (mAh)
    *   I: 平均电流消耗 (A)
    *   η: 系统效率系数 (0.8-0.9)
*   **约束公式**: T = (C / 1000) / I × 60 × η

**约束块**: 电机推力需求分析
*   **物理意义与应用**: 根据无人机重量和飞行性能要求计算所需推力，用于电机选型和功率分配。
*   **参数**: 
    *   F: 所需总推力 (N)
    *   M: 无人机总质量 (kg)
    *   a: 最大爬升加速度 (m/s²)
    *   g: 重力加速度 (9.8 m/s²)
    *   k: 安全系数 (1.2-1.5)
*   **约束公式**: F = M × (g + a) × k

## 7. 交互序列

**场景名称**: 起飞指令执行序列
*   **交互背景**: 操作员通过地面站发送起飞指令，无人机各系统协同工作完成起飞准备和执行过程，确保起飞过程安全可控。
*   **涉及的生命线**: GroundStation, FlightController, SensorFusion, PowerManagement, PropulsionSystem
*   **消息序列**: 
    1.  GroundStation -> FlightController: takeoff_command(altitude)
    2.  FlightController -> PowerManagement: request_power_status()
    3.  PowerManagement -> FlightController: battery_status(level, voltage)
    4.  FlightController -> SensorFusion: request_sensor_data()
    5