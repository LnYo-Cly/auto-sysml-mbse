# 无人机系统设计文档

**上下文设定**: 本系统设计文档针对一个用于农业测绘的四旋翼无人机系统。该系统具备自主飞行能力，续航时间30分钟，最大载重5公斤，集成多光谱相机用于作物监测，并支持实时数据传输和紧急安全协议。系统符合RTCA DO-178C航空软件标准和ISO 19156地理信息观测标准。

## 1. 需求规格

### 功能性需求

*   `REQ-FUN-001`: **自主飞行控制**
    *   **背景与上下文**: 在农业测绘任务中，无人机需要按照预设的GPS航点自动飞行，以减少人工操作误差并提高测绘效率。
    *   **详细描述**: 系统应能接收并解析来自地面控制站（GCS）的飞行计划（包含一系列WGS-84坐标系下的GPS坐标和高度指令）。飞行控制器（FCU）应采用自适应PID控制算法，结合来自IMU（MPU-9250，采样率1kHz）和GPS模块（u-blox NEO-M8N，定位精度2.5m CEP）的实时数据，通过四元数姿态表示法动态调整四个电机的转速。航迹跟踪精度要求：水平误差≤1.0m（2σ），垂直误差≤0.5m（2σ）。控制频率不低于400Hz。
    *   **理由 (Rationale)**: 实现自动化作业，确保数据收集的连续性和路径一致性，符合精准农业ASABE EP-542标准。
    *   **验证方法 (Verification)**: 硬件在环测试（HIL）、实飞验证、航迹分析
    *   **优先级 (Priority)**: High

*   `REQ-FUN-002`: **多光谱数据采集与存储**
    *   **背景与上下文**: 为了分析作物的健康状况，需要捕获特定波段（如近红外、红边）的光谱图像。
    *   **详细描述**: 系统应在飞行过程中，根据预设的触发条件（到达特定航点±3m范围内或固定时间间隔2-5s可调），控制多光谱相机（MicaSense RedEdge-MX，5个波段：蓝475nm、绿560nm、红668nm、红边717nm、近红外842nm）进行拍照。空间分辨率要求：在120m飞行高度下达到8cm/像素。采集到的图像数据（每张约12MB，格式为16位GeoTIFF+XML元数据）应被UTC时间戳和DGPS位置（精度≤10cm）标记，并通过数传电台（传输速率115.2kbps）实时传输至地面站。同时，数据应存储在机载的64GB Class 10 UHS-I microSD卡中，存储容量需支持至少5000张原始图像。
    *   **理由 (Rationale)**: 获取关键的农情信息，为精准农业决策提供数据支持，符合NDVI植被指数计算规范。
    *   **验证方法 (Verification)**: 功能测试、现场演示、数据完整性校验
    *   **优先级 (Priority)**: High

*   `REQ-FUN-003`: **实时状态监控与遥测**
    *   **背景与上下文**: 操作员需要实时了解无人机的飞行状态和系统健康度，以确保任务安全和有效执行。
    *   **详细描述**: 系统应通过MAVLink 2.0协议，以10Hz±1Hz的频率向地面控制站发送遥测数据包。数据包内容必须包括：GPS位置（经纬度精度1e-7度，海拔精度0.1m）、姿态角（滚转、俯仰精度0.1°，偏航精度0.5°）、空速（量程0-30m/s，精度0.5m/s）、电池电压（量程0-25.2V，精度±0.1V）、电池剩余电量（精度±5%）、电机转速（量程0-20000RPM，精度±100RPM）和信号链路强度（量程-120至0dBm，精度±3dB）。数据丢包率应小于1%。
    *   **理由 (Rationale)**: 为操作员提供态势感知，便于监控和干预，符合ASTM F38.01无人机遥测标准。
    *   **验证方法 (Verification)**: 协议一致性测试、数据完整性验证、现场演示
    *   **优先级 (Priority)**: High

*   `REQ-FUN-004`: **安全故障处理与自动返航**
    *   **背景与上下文**: 在通信链路丢失或电池电量过低等紧急情况下，系统必须能够自主采取安全措施，防止坠机。
    *   **详细描述**: 当检测到以下任一条件时，系统应自动触发失效保护模式并执行返航着陆（RTL）程序：1) 与地面站的RC控制信号丢失持续超过5.0±0.5秒；2) 电池电压低于预设的3.4V/单体（对于4S电池组，即总电压低于13.6V±0.2V）；3) GPS卫星数少于8颗持续30秒。RTL程序包括：爬升至预设安全高度（50±5m，可配置）、以5m/s速度飞向并降落在预设的"家"位置（Home Position，精度半径2m内）。着陆过程应包含3m高度悬停3秒的确认阶段。
    *   **理由 (Rationale)**: 最大限度地保证飞行器本体和地面人员、财产的安全，符合FAA Part 107安全规范。
    *   **验证方法 (Verification)**: 故障注入测试、安全案例分析、现场演示
    *   **优先级 (Priority)**: High

### 非功能性需求

*   `REQ-NFN-001`: **飞行控制响应时间**
    *   **背景与上下文**: 为了确保飞行稳定性和对突发气流扰动的抵抗能力，控制回路必须具有极低的延迟。
    *   **详细描述**: 从IMU传感器读取数据到计算并输出PWM信号至电调（ESC）的完整控制回路延迟必须小于8毫秒（P95值），最大延迟不超过10毫秒。姿态控制带宽不低于20Hz，位置控制带宽不低于5Hz。
    *   **理由 (Rationale)**: 快速响应是维持四旋翼无人机姿态稳定的关键，延迟过大会导致振荡甚至失控，符合无人机飞行品质等级2要求。
    *   **验证方法 (Verification)**: 时序分析、示波器测量、频率响应测试
    *   **优先级 (Priority)**: High

*   `REQ-NFN-002`: **系统可靠性**
    *   **背景与上下文**: 农业测绘任务通常在大面积农田上进行，系统故障可能导致任务失败和经济损失。
    *   **详细描述**: 系统在单次30分钟的任务周期内，其关键功能（如飞行控制、通信、动力）的可靠性（可用性）应不低于99.95%。平均故障间隔时间（MTBF）应大于800小时，平均修复时间（MTTR）小于30分钟。系统应实现故障容错等级FTL-2（单点故障不导致系统失效）。
    *   **理由 (Rationale)**: 保证任务的成功完成率，降低维护和运营成本，符合IEC 61508 SIL-2安全完整性等级。
    *   **验证方法 (Verification)**: FMEA分析、可靠性预测、加速寿命测试
    *   **优先级 (Priority)**: High

*   `REQ-NFN-003`: **环境适应性**
    *   **背景与上下文**: 无人机需要在户外多变的环境中稳定工作，包括风、温和湿度变化。
    *   **详细描述**: 系统应能在以下环境条件下正常运行：环境温度范围-15°C至50°C（操作温度），存储温度-30°C至60°C；最大抗风能力为12米/秒（6级风，阵风15m/s）；防护等级至少为IP54（防尘、防溅水）；相对湿度范围5%至95%无冷凝。电磁兼容性应符合FCC Part 15和CE EN 300328标准。
    *   **理由 (Rationale)**: 确保系统在典型的农业作业环境中具备足够的鲁棒性，适应全球主要农业区域气候条件。
    *   **验证方法 (Verification)**: 环境应力筛选、风洞测试、EMC测试
    *   **优先级 (Priority)**: Medium

*   `REQ-NFN-004`: **续航与载重能力**
    *   **背景与上下文**: 续航和载重能力直接决定了单次任务能够覆盖的农田面积和所能搭载的传感器类型。
    *   **详细描述**: 在最大载重5.0±0.2公斤（包括相机、云台等有效载荷）的条件下，系统使用16000mAh 6S锂聚合物电池（标称电压22.2V），应能实现不少于30分钟的有效飞行时间（从起飞到着陆，保留15%的安全电量）。悬停功耗不超过800W，最大爬升功耗不超过1500W。单次任务覆盖面积应不小于100公顷（在120m飞行高度下）。
    *   **理由 (Rationale)**: 满足典型农场单次测绘任务的作业范围需求，符合商业农业测绘服务标准。
    *   **验证方法 (Verification)**: 负载测试、续航测试、功耗分析
    *   **优先级 (Priority)**: High

## 2. 系统结构

### 系统顶层架构设计理念
本系统采用分层模块化架构，核心设计原则是功能解耦与高内聚。将系统划分为感知、决策、执行和通信四个逻辑层，以确保各模块职责清晰，接口明确，便于维护、测试和升级。架构符合AUTOSAR自适应平台理念，支持ARINC 653分区调度。系统采用双冗余设计关键路径，确保功能安全。

### 块定义

*   `**FlightControllerUnit**`
    *   **概述 (Overview)**: 作为无人机的大脑，飞行控制器单元负责处理所有传感器数据，运行核心控制算法，并协调所有子系统的行为。它采用ARM Cortex-M7微处理器（主频400MHz，带FPU），确保控制回路的实时性。符合DO-178C DAL-C设计保证等级。
    *   **核心职责 (Core Responsibilities)**:
        *   运行姿态解算算法（Mahony互补滤波，更新率500Hz）
        *   执行位置保持和航点跟踪的L1非线性导引律和PID控制律
        *   管理飞行状态机并执行失效保护协议
        *   通过CAN 2.0B（1Mbps）与电调通信，通过UART（921600bps）与传感器和通信模块交互
        *   实现传感器健康监控和数据有效性检查
    *   **关键属性 (Attributes)**: `- currentAttitude: Attitude [degrees] {-180..180,精度0.1°}`, `- targetWaypoint: GPS_Coordinate {lat:double[-90..90],lon:double[-180..180],alt:float[-1000..10000]}`, `- systemMode: SystemMode {BOOT, STANDBY, MANUAL, AUTO_MISSION, AUTO_LOITER, RTL, FAILSAFE}`, `- controlFrequency: uint16_t [Hz] {100..1000}`
    *   **核心操作 (Operations)**: `- calculateControlOutput(imuData: IMU_Data, gpsData: GPS_Data): PWM_Signal {updateRate:400Hz}`, `- executeFailsafeAction(failsafeTrigger: FailsafeType, severity: uint8_t): Status`, `- updateStateMachine(event: SystemEvent, priority: uint8_t): void`, `- validateSensorData(sensorType: SensorID, data: SensorData): bool`

*   `**PowerManagementSystem**`
    *   **概述 (Overview)**: 动力管理系统负责为整个无人机提供稳定、可靠的电力供应，并实时监控电池健康状况，它是系统续航和安全的关键。集成智能电池管理算法，符合IEC 62133电芯安全标准。
    *   **核心职责 (Core Responsibilities)**:
        *   通过电源分配板（PDB，效率>95%）将主电池电压分配至各子系统（12V/5V/3.3V电源轨）
        *   通过库仑计芯片（MAX17048）实时采集电池电压、电流和估算剩余容量（精度±3%）
        *   实现过压（>25.5V）、欠压（<19V）、过流（>45A）硬件保护
        *   支持电池健康状态（SOH）估算和循环次数统计
    *   **关键属性 (Attributes)**: `- batteryVoltage: Real [V] {0..25.2,精度0.01V}`, `- batteryCapacityRemaining: Real [%] {0..100,精度1%}`, `- totalCurrentDraw: Real [A] {0..60,精度0.1A}`, `- batteryTemperature: Real [°C] {-20..80,精度1°C}`, `- cycleCount: uint16_t {0..1000}`
    *   **核心操作 (Operations)**: `- distributePower(load: PowerLoad, priority: uint8_t): Voltage`, `- getBatteryHealth(): BatteryStatus {SOH:float,internalResistance:float}`, `- shutdownPowerRail(rail: PowerRail, emergency: bool): void`, `- estimateRemainingFlightTime(powerProfile: PowerProfile): float`

*   `**SensorFusionModule**`
    *   **概述 (Overview)**: 传感器融合模块汇集并处理来自多种异构传感器的原始数据，为飞行控制器提供精确、可靠的姿态、位置和速度信息。采用扩展卡尔曼滤波（EKF2）算法，支持多传感器冗余。
    *   **核心职责 (Core Responsibilities)**:
        *   从IMU（BMI088，加速度计量程±16g，陀螺仪量程±2000dps）读取原始数据（采样率1kHz）
        *   从GPS模块（NEO-M8N，支持GPS/GLONASS/Galileo）接收位置、速度和时间信息（更新率10Hz）
        *   从气压计（MS5611，精度0.1mbar）获取高度数据
        *   从磁力计（RM3100，精度0.1μT）获取航向信息
        *   运行EKF2传感器融合算法（状态向量15维，更新率100Hz）
    *   **关键属性 (Attributes)**: `- fusedPosition: GPS_Coordinate {lat:double,lon:double,alt:float,精度:水平2.5m,垂直1.0m}`, `- fusedVelocity: Velocity [m/s] {vx:float,vy:float,vz:float,精度0.1m/s}`, `- fusedAttitude: Attitude [degrees] {roll:float,pitch:float,yaw:float,精度:滚转/俯仰0.5°,偏航1.0°}`, `- fusionHealth: uint8_t {0..100}`, `- sensorCovariance: Matrix3x3`
    *   **核心操作 (Operations)**: `- readIMUData(): IMU_Data {timestamp:uint32_t,accel:Vector3f,gyro:Vector3f}`, `- readGPSData(): GPS_Data {fixType:uint8_t,satellites:uint8_t,hdop:float}`, `- runFusionAlgorithm(): FusedNavData {updateRate:100Hz}`, `- calibrateSensors(calibrationType: CalibMode): Status`

*   `**PropulsionSystem**`
    *   **概述 (Overview)**: 推进系统是无人机的执行机构，它将飞控的计算指令转化为实际的升力和力矩，通过精确控制四个无刷电机和螺旋桨的转速来实现飞行器的运动。采用BLDC电机和32位电调，支持DShot600数字协议。
    *   **核心职责 (Core Responsibilities)**:
        *   接收来自飞控的PWM/DShot控制信号（更新率400Hz）
        *   通过电子调速器（ESC，BLHeli_32固件）驱动无刷电机（T-Motor MN4010，KV值400）以目标转速旋转
        *   提供电机转速反馈（通过霍尔传感器，精度±50RPM）
        *   实现电机温度监控和过载保护
        *   支持螺旋桨推力系数校准
    *   **关键属性 (Attributes)**: `- motorSpeed: Integer [RPM] {0..20000,精度100RPM}`, `- motorTemperature: Real [°C] {-40..120,精度2°C}`, `- thrustOutput: Real [N] {0..150,精度1N}`, `- escTelemetry: ESC_Data {voltage:float,current:float,temperature:float}`
    *   **核心操作 (Operations)**: `- setMotorSpeed(pwmSignal: PWM_Signal, motorID: uint8_t): void`, `- getMotorTelemetry(): MotorTelemetry {updateRate:50Hz}`, `- calibrateESCs(): Status`, `- emergencyStop(motorID: uint8_t): void`

*   `**DataLinkModule**`
    *   **概述 (Overview)**: 数据链模块是无人机与外部世界（主要是地面控制站）通信的桥梁，负责双向传输控制指令、遥测数据和任务载荷数据。采用双频段冗余设计，支持AES-256加密。
    *   **核心职责 (Core Responsibilities)**:
        *   通过数传电台（SiK Radio，900MHz/2.4GHz可选）以MAVLink 2.0协议与地面站通信（最大传输距离10km）
        *   通过RC接收机（FrSky R9MM，支持SBUS）接收来自遥控器的直接操控指令（更新率50Hz）
        *   实现链路质量监控和自动频段切换
        *   支持数据加密和身份认证
        *   提供通信延迟统计（平均延迟<100ms）
    *   **关键属性 (Attributes)**: `- linkQuality: Real [dBm] {-120..0,精度1dBm}`, `- dataRate: Real [kbps] {0..100,精度1kbps}`, `- packetLoss: Real [%] {0..100,精度0.1%}`, `- rssi: Real [dBm] {-120..0}`, `- encryptionStatus: bool`
    *   **核心操作 (Operations)**: `- transmitTelemetry(telemetryData: TelemetryPacket, priority: uint8_t): Status`, `- receiveCommand(timeout: uint16_t): MAVLink_Message`, `- checkRCSignal(): RC_Signal_Status {lost:bool,quality:uint8_t}`, `- switchFrequency(band: FrequencyBand): Status`

*   `**MissionPayload**`
    *   **概述 (Overview)**: 任务载荷是实现无人机特定应用功能的核心，在本系统中特指多光谱相机及其稳定云台，它直接决定了数据产品的质量。支持IEEE 1588精密时间协议。
    *   **核心职责 (Core Responsibilities)**:
        *   根据飞控或地面站的指令控制相机进行拍照或录像（快门延迟<50ms）
        *   通过三轴云台（STorM32控制器）稳定相机，控制精度0.01°
        *   预处理采集到的图像数据（辐射定标、镜头畸变校正）
        *   管理机载存储设备（支持热插拔）
        *   生成数据质量报告和采集日志
    *   **关键属性 (Attributes)**: `- cameraTriggerInterval: Real [s] {0.1..10.0,精度0.01s}`, `- gimbalOrientation: Attitude [degrees] {-180..180,精度0.1°}`, `- storageUsage: Real [GB] {0..64,精度0.1GB}`, `- imageCount: uint32_t {0..10000}`, `- payloadTemperature: Real [°C] {-10..60}`
    *   **核心操作 (Operations)**: `- captureImage(triggerSource: TriggerType): ImageData {timestamp:uint64_t,gps:GPS_Coordinate}`, `- stabilizeGimbal(attitudeRef: Attitude, mode: GimbalMode): void`, `- transferDataToStorage(image: ImageData, compression: CompressType): Status`, `- performRadiometricCalibration(): CalibrationData`

### 内部结构与交互原理

*   `**上下文**: UAV_System（无人机系统）`
    *   **设计阐述**: 无人机系统的内部设计围绕飞行控制器单元（FCU）这一核心展开。FCU通过高速内部总线（SPI@10MHz用于IMU，I2C@400kHz用于其他传感器）与传感器模块紧密交互，获取导航信息；通过CAN 2.0B@1Mbps向推进系统发送高频率控制指令；通过UART@921600bps与数据链和任务载荷通信。电源管理系统采用星型拓扑，通过12AWG硅胶线分配电力。关键信号路径采用双冗余设计（如IMU冗余、电源冗余）。系统架构支持在线故障检测和隔离，符合ARINC 653时间空间分区要求。
    *   **组成部分 (Parts)**: `fc1: FlightControllerUnit {redundancy:primary}`, `pms1: PowerManagementSystem {voltageMonitoring:true}`, `sfm1: SensorFusionModule {ekfEnabled:true}`, `ps1: PropulsionSystem {motorCount:4}`, `dlm1: DataLinkModule {frequencyBand:dual}`, `mp1: MissionPayload {cameraType:multispectral}`
    *   **连接关系 (Connectors)**:
        *   `[sfm1.navDataPort] <SPI> [fc1.sensorInputPort] {dataRate:2Mbps,frame:SPI_Mode3}` (传输融合后的导航数据，消息类型：FusedNavData，大小：64字节)
        *   `[fc1.motorControlPort] --CAN 2.0B--> [ps1.escCommandPort] {bitrate:1Mbps,messageID:0x100}` (传输电机控制指令，消息类型：MotorControlMsg，周期：2.5ms)
        *   `[pms1.powerOut] --12AWG Power Cable--> [fc1.powerIn], [ps1.powerIn], [dlm1.powerIn], [mp1.powerIn] {voltage:22.2V,maxCurrent:45A}` (分配电力，包含过流保护)
        *   `[pms1.batteryTelemetryPort] <I2C> [fc1.telemetryInputPort] {address:0x36,updateRate:10Hz}` (传输电池状态，消息类型：BatteryStatus，大小：16字节)
        *   `[dlm1.commandOutputPort] <UART> [fc1.commandInputPort] {baudrate:921600,parity:None}` (传输来自地面的指令，协议：MAVLink 2.0)
        *   `[fc1.telemetryOutputPort] <UART> [dlm1.telemetryInputPort] {baudrate:921600,parity:None}` (传输遥测数据，协议：MAVLink 2.0，周期：100ms)
        *   `[fc1.payloadCommandPort] <UART> [mp1.controlPort] {baudrate:115200,parity:None}` (传输载荷控制指令，协议：Custom Binary)
        *   `[mp1.dataOutputPort] <USB 2.0> [dlm1.payloadDataInputPort] {speed:480Mbps,burstSize:16KB}` (传输图像数据至数传，协议：RTP over UDP)

## 3. 活动流程

*   `**活动名称**: 自主测绘任务执行流程`
*   **流程概述**: 此流程描述了无人机从接收到地面站发出的"开始任务"指令，到完成预定航线的测绘并返回待机状态的完整自动化过程。采用BPMN 2.0标准建模，包含异常处理路径。流程支持任务暂停、继续和动态航点更新功能。
*   **输入/输出 (Parameters)**: `IN: start_mission_command: MAVLink_Command {msgid:76,component:1}`, `mission_plan: FlightPlan {waypointCount:50..500,CRS:WGS84}`, `OUT: mission_status: MissionReport {success:bool,imagesCaptured:uint16_t}`, `collected_imagery: ImageDataSet {format:GeoTIFF,count:uint16_t}`
*   **步骤序列 (Actions)**:
    1.  **验证指令与计划**: 飞行控制器接收并解析"开始任务"指令（MAV_CMD_MISSION_START），检查飞行计划的完整性和有效性（航点数量50-500，安全高度30-150m，总航程≤15km）。验证失败则发送NACK。
    2.  **解锁电机并起飞**: 飞控发送MAV_CMD_COMPONENT_ARM_DISARM解锁指令，等待所有电机初始化完成（超时3s）。控制无人机以1.5m/s垂直起飞至第一个航点的起始高度±2m。
    3.  **导航至下一航点**: 飞控根据传感器融合模块提供的实时位置，计算与目标航点的横向偏差和高度偏差，运行L1导航算法（收敛时间<10s）生成电机控制指令。巡航速度8m/s，最大Bank角30°。
    4.  **检查航点到达条件**: 当无人机进入以目标航点为中心、半径为5m的圆柱形空域（水平容差5m，垂直容差2m）并保持2秒时，判定为到达该航点。
    5.  **触发数据采集**: 在到达航点时，飞控通过任务载荷控制端口发送"拍照"指令（触发脉冲宽度20ms）。任务载荷模块执行拍照操作（曝光时间1/1000s），并为图像添加GPS坐标（精度≤10cm）和PTP时间戳（精度≤1ms）。
    6.  **数据传输与存储**: 采集到的图像数据通过数据链模块尝试实时下传（QoS：尽力而为），同时被写入机载存储（写入速度≥20MB/s）。每完成10张图像传输后发送传输确认。
    7.  **循环执行**: 重复步骤3至6，直至飞行计划中的所有航点都被访问完毕。支持动态跳过故障航点（连续3次无法到达）。
    8.  **执行返航着陆**: 飞控触发MAV_CMD_NAV_RETURN_TO_LAUNCH指令，无人机以5m/s速度爬升至RTL安全高度，飞向Home位置（精度半径2m内）并执行自动着陆序列（下降率1m/s，触地检测压力阈值1.5kg）。
    9.  **任务结束报告**: 着陆并上锁电机后，飞控生成任务报告（包括完成的航点数、采集的图像数、飞行时间、平均速度等），通过数据链发送至地面站，同时写入黑匣子（循环记录，容量4GB）。

## 4. 状态机行为

*   `**上下文块**: FlightControllerUnit`
*   **行为模型概述**: 飞行控制器的行为模型定义了无人机从物理上电到任务结束下电的完整生命周期。采用UML 2.5状态机规范，支持层次状态和正交区域。状态转换包含严格的优先级机制，FAILSAFE状态具有最高优先级。符合DO-178C状态机设计模式。
*   **状态定义**:
    *   `**状态名称**: INIT`
        *   **描述**: 系统刚上电，正在进行硬件自检和软件初始化。完成所有外围设备枚举和参数加载。
        *   `entry / initializeHardware(); loadParametersFromEEPROM(); startWatchdogTimer(1000ms)`
        *   `do / 运行内置测试（BIT），检查传感器（IMU, GPS, 磁力计）、通信链路、电机响应，完成传感器校准`
        *   `exit / 关闭看门狗定时器；发布系统就绪事件`
    *   `**状态名称**: STANDBY`
        *   **描述**: 系统初始化完成，电机未上锁，等待用户指令。持续监控系统健康状况。
        *   `entry / 启动遥测数据流发送(10Hz)；开启RC信号监控`
        *   `do / 持续监控遥控器信号和地面站指令；更新电池状态显示；检查GPS锁定状态`
        *   `exit / 停止遥测流；保存系统配置`
    *   `**状态名称**: MANUAL`
        *   **描述**: 无人机由操作员通过遥控器直接控制飞行。支持姿态模式和定高模式。
        *   `entry / 解锁电机；切换到手动控制模式；启用RC死区处理(±5%)`
        *   `do / 将RC接收机的SBUS信号映射为姿态角(滚转±30°、俯仰±30°)或油门指令(0-100%)；运行姿态稳定PID`
        *   `exit / 上锁电机；保存操纵杆校准数据`
    *   `**状态名称**: AUTO_MISSION`
        *   **描述**: 无人机正在自动执行预定义的飞行计划（航点跟踪）。支持任务暂停和航点更新。
        *   `entry / 载入飞行计划；启动航点跟踪控制器；重置任务统计计数器`
        *   `do / 持续运行导航和控制算法，跟踪预定航线；监控航点到达条件；处理载荷触发事件`
        *   `exit / 停止航点跟踪控制器；保存任务执行日志`
    *   `**状态名称**: RETURN_TO_LAUNCH`
        *   **描述**: 系统正在执行自动返航并着陆程序。包含安全高度爬升和精确着陆序列。
        *   `entry / 记录当前状态；中止任何进行中的任务；命令无人机爬升至RTL安全高度(50m)`
        *   `do / 导航至Home位置；在Home点上方执行着陆程序(下降率0.5-1.0m/s)；持续监控着陆区域安全性`
        *   `exit / 上锁电机；发布着陆完成事件；切换至STANDBY状态`
    *   `**状态名称**: FAILSAFE`
        *   **描述**: 系统检测到严重故障（如电量极低、通信完全丢失、传感器失效），正在执行最高优先级的保护动作。
        *   `entry / 记录故障码(错误源、严重等级、时间戳)；中止当前任何任务；触发声光报警`
        *   `do / 根据具体的故障类型执行预设的应对策略（低电量：立即RTL；传感器失效：悬停等待；严重故障：紧急着陆）`
        *   `exit / 仅在故障条件解除且收到外部复位指令后退出；需要授权密码确认`
    *   `**状态名称**: LANDED`
        *   **描述**: 无人机已成功着陆，电机已上锁，但系统仍未断电。保持基本监控功能。
        *   `entry / 上锁电机；发送"Landed"状态消息；启动着陆后自检`
        *   `do / 继续保持传感器数据和遥测发送(1Hz)；监控电池温度；等待用户指令`
        *   `exit / 停止着陆后自检；清除着陆状态标志`
*   **转换 (Transitions)**:
    *   `[INIT] --[BIT_Passed && GPS_3D_Fix] / reportStatus("Ready")--> [STANDBY]`
    *   `[STANDBY] --[RC_Armed_Signal && GPS_Health_OK] / armMotors()--> [MANUAL]`
    *   `[STANDBY] --[GCS_Auto_Command && Mission_Valid] / loadMission()--> [AUTO_MISSION]`
    *   `[MANUAL] --[RC_Disarmed_Signal || Auto_Transition_Timeout] / disarmMotors()--> [STANDBY]`
    *   `[AUTO_MISSION] --[Mission_Complete || Waypoint_Error] / reportMissionComplete()--> [RETURN_TO_LAUNCH]`
    *   `[任何状态] --[Low_Battery_Alert[batteryVoltage < 13.6V] || Critical_Sensor_Failure] / triggerFailsafe(CRITICAL)--> [FAILSAFE]`
    *   `[任何状态(除FAILSAFE)] --[RC_Signal_Lost[time > 5.0s] || GCS_Link_Lost[time > 10.0s]] / triggerFailsafe(LINK_LOST)--> [RETURN_TO_LAUNCH]`
    *   `[RETURN_TO_LAUNCH] --[Vehicle_Landed[weightOnWheels > 1.0kg] && Motors_Stopped] / disarmMotors()--> [LANDED]`
    *   `[LANDED] --[GCS_Disarm_Command || Auto_Shutdown_Timeout[300s]] / saveLogs()--> [STANDBY]`

## 5. 用例场景

*   `**用例名称**: 执行农田测绘任务`
*   **场景简述 (Narrative)**: 农业技术员李四需要对一块500亩的玉米地进行生长状况评估。他首先在办公室使用地面站软件（QGroundControl）规划好详细的飞行航线（航点数量150个，飞行高度120m，航向重叠率80%，旁向重叠率70%），并设置好多光谱相机的拍摄间隔（2秒）。到达田间后，他选择一块平坦安全的区域（30m×30m）作为起降场，进行GPS差分校正。启动无人机后，系统自动完成健康检查。无人机自主起飞，严格按照规划航线飞行（巡航速度8m/s），并在每个航点自动拍照。李四通过平板电脑上的地面站软件实时查看无人机位置、电池状态和图像采集进度。任务完成后，无人机自动返回并降落在起降点（着陆精度±1.5m）。李四回收无人机，通过USB 3.0接口导出数据（总数据量约45GB）用于后续分析。
*   **参与者 (Actors)**: `Primary: 农业技术员（角色：操作员）`, `Secondary: 地面控制站软件（QGroundControl v4.2）`, `Supporting: 气象站（提供实时风速数据）`
*   **基本流程 (Happy Path)**:
    1.  技术员通过地面站上传飞行计划至无人机（传输时间<30s）。
    2.  技术员在安全环境下进行起飞前检查（GPS卫星数≥12，HDOP<1.0，电池电量>95%）后发出"自动起飞"指令。
    3.  无人机起飞（垂直上升率2m/s）并开始按航线飞行（航向精度<1.0m）。
    4.  无人机在每个航点自动触发相机拍照（成功率>99.5%），实时下传缩略图。
    5.  无人机完成所有航点后自动返航（剩余电量>25%）并着陆（着陆速度<0.5m/s）。
    6.  技术员确认任务完成，下载完整数据（传输速率50MB/s），生成作业报告。
*   **备选/异常流程**:
    *   **通信中断**: 如果在任务中与地面站的数传链路中断超过10秒，无人机将根据预设策略继续完成任务（如链路预期恢复时间<5分钟）或执行返航（如链路质量持续恶化）。
    *   **电量不足**: 如果在任务中途电池电量低于安全阈值（25%），无人机将立即中止任务，计算最优返航路径，并自动返航（考虑逆风因素）。
    *   **恶劣天气**: 技术员通过地面站监控到风速过大（>10m/s），手动发送指令中止任务，命令无人机立即返航（紧急下降率3m/s）。
    *   **传感器故障**: 如果主要GPS失效，系统切换至备用GPS；如果IMU故障，进入悬停模式等待指令。

## 6. 参数关系

*   `**约束块**: FlightTimeEstimation`
*   **物理意义与应用**: 此约束用于在任务规划阶段估算无人机的最大飞行时间。基于电池化学特性、环境温度和飞行剖面进行精确计算，是评估任务可行性和规划航线长度的关键依据。符合Peukert定律和电池老化模型。
*   **参数 (Parameters)**: `TotalBatteryCapacity: Real [mAh] {标称值:16000,实际值:15200-16500}`, `AveragePowerConsumption: Real [W] {悬停:650-750,巡航:550-650}`, `BatteryVoltage: Real [V] {标称:22.2,工作范围:19.0-25.2}`, `EstimatedFlightTime: Real [minutes] {计算值:25-35}`, `BatteryAgeFactor: Real {0.8-1.0}`, `TemperatureFactor: Real {0.9-1.1}`
*   **约束公式 (Constraint)**:
    *   `TotalUsableEnergy [Wh] = (TotalBatteryCapacity [mAh] * BatteryVoltage [V] * BatteryAgeFactor) / 1000 * 0.85` (保留15%安全电量)
    *   `EstimatedFlightTime [minutes] = (TotalUsableEnergy [Wh] / (AveragePowerConsumption [W] * TemperatureFactor)) * 60`

*   `**约束块**: MaximumLiftConstraint`
*   **物理意义与应用**: 该约束确保推进系统产生的总升力足以克服无人机自身的重力及其所承载的有效载荷，考虑空气密度、螺旋桨效率和电机性能衰减。是保证飞行安全和实现载重指标的根本物理原理，符合FAR Part 107载重认证要求。
*   **参数 (Parameters)**: `TotalThrust: Real [N] {单电机:40-50,总量:160-200}`, `UAV_Mass: Real [kg] {净重:3.5,最大起飞重量:8.5}`, `Payload_Mass: Real [kg] {设计值:5.0,实际:4.5-5.2}`, `Gravity: Real [m/s^2] = 9.80665`, `AirDensity: Real [kg/m^3] {海平面:1.225,1000m:1.112}`, `ThrustMargin: Real [%] {安全裕度:15-20}`
*   **约束公式 (Constraint)**:
    *   `TotalThrust >= (UAV_Mass + Payload_Mass) * Gravity * (1 + ThrustMargin/100) / (AirDensity/1.225)`

*   `**约束块**: NavigationAccuracy`
*   **物理意义与应用**: 定义无人机导航系统的精度要求，涉及传感器误差、控制算法性能和外部环境因素。是保证测绘数据质量和作业精度的关键参数。
*   **参数 (Parameters)**: `GPS_Position_Error: Real [m] {CEP:2.5}`, `IMU_Attitude_Error: Real [°] {RMS:0.5}`, `Control_Tracking_Error: Real [m] {RMS:1.0}`, `Total_Position_Uncertainty: Real [m] {95%置信区间:3.5}`
*   **约束公式 (Constraint)**:
    *   `Total_Position_Uncertainty = sqrt(GPS_Position_Error^2 + Control_Tracking_Error^2 + (IMU_Attitude_Error*π/180*FlightHeight)^2)`

## 7. 交互序列

*   `**场景名称**: 处理低电量紧急情况`
*   **交互背景**: 本序列描述了当动力管理系统的电池监测电路检测到电压低于安全阈值时，系统内部各组件如何协同工作，触发并执行自动返航安全程序的完整过程。采用UML 2.5序列图规范，包含时间约束和状态条件。此交互确保了在能源危机下的系统安全，响应时间要求<2.0秒。
*   **涉及的生命线 (Lifelines)**: `[PowerManagementSystem]`, `[FlightControllerUnit]`, `[DataLinkModule]`, `[PropulsionSystem]`, `[GroundControlStation]`
*   **消息序列 (Messages)**:
    1.  `[PowerManagementSystem] -> [FlightControllerUnit]: BatteryAlert(LOW_VOLTAGE, voltage=13.5V, confidence=95%)` {周期:100ms，当电压连续3个周期低于13.6V时触发}
    2.  `[FlightControllerUnit] -> [FlightControllerUnit]: evaluateCondition()[priority:CRITICAL, timeout:100ms]` (飞控内部逻辑判断触发失效保护条件，检查电压趋势和负载情况)
    3.  `[FlightControllerUnit] -> [DataLinkModule]: sendTelemetry(STATUS_CRITICAL, "Low Battery RTL Triggered", battery_level=20%)` {QoS:高优先级，重试次数:3} (立即向地面站发送紧急状态通知)
    4.  `[GroundControlStation] -> [DataLinkModule]: ACK(STATUS_CRITICAL)` {期望响应时间:<500ms}
    5.  `[FlightControllerUnit] -> [FlightControllerUnit]: transitionTo(RETURN_TO_LAUNCH)[abortCurrentTasks:true]` (飞控状态机切换到返航状态，中止所有进行中的任务)
    6.  `[FlightControllerUnit] -> [PropulsionSystem]: setMotorSpeed(Climb_PWM, climb_rate=3m/s, target_altitude=50m)` {控制模式:位置控制} (控制无人机爬升至RTL安全高度)
    7.  `[FlightControllerUnit] -> [PropulsionSystem]: setMotorSpeed(Navigate_To_Home_PWM, cruise_speed=6m/s, bank_angle_limit=25°)` {导航算法:L1} (控制无人机飞向Home点)
    8.  `[FlightControllerUnit] -> [DataLinkModule]: sendTelemetry(POSITION_DATA, RTL_progress=65%, estimated_remaining_time=120s)` {周期:2s} (持续发送位置信息，让地面站了解返航进度)
    9.  `[FlightControllerUnit] -> [PropulsionSystem]: setMotorSpeed(Landing_Sequence_PWM, descent_rate=1m/s, flare_altitude=3m)` {着陆模式:精确着陆} (在Home点上方执行着陆程序)
    10. `[PropulsionSystem] -> [FlightControllerUnit]: MotorTelemetry(rpm=0, temperature=45°C, status=STOPPED)` {验证条件:所有电机转速<100RPM} (着陆后，电机停转)
    11. `[FlightControllerUnit] -> [DataLinkModule]: sendTelemetry(STATUS_OK, "Landed Safely", final_battery=18%)` {QoS:确认传输} (发送安全着陆确认消息)
    12. `[FlightControllerUnit] -> [PowerManagementSystem]: PowerSaveMode(enable=true, keepalive_interval=30s)` (进入低功耗模式，延长待机时间)