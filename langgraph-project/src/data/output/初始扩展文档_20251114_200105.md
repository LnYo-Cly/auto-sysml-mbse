# 无人机系统设计文档

**上下文设定**: 本系统设计文档针对一个用于农业测绘的四旋翼无人机系统。该系统具备自主飞行能力，续航时间30分钟，最大载重5公斤，集成多光谱相机用于作物监测，并支持实时数据传输和紧急安全协议。

## 1. 需求规格

### 功能性需求

*   `REQ-FUN-001`: **自主飞行控制**
    *   **背景与上下文**: 在农业测绘任务中，无人机需要按照预设的GPS航点自动飞行，以减少人工操作误差并提高测绘效率。
    *   **详细描述**: 系统应能接收并解析来自地面控制站（GCS）的飞行计划（包含一系列GPS坐标和高度指令）。飞行控制器（FCU）应使用PID控制算法，结合来自IMU（惯性测量单元）和GPS模块的实时数据，动态调整四个电机的转速，以稳定姿态并精确跟踪预定航线。航线跟踪误差应小于1.0米。
    *   **理由 (Rationale)**: 实现自动化作业，确保数据收集的连续性和路径一致性。
    *   **验证方法 (Verification)**: Test
    *   **优先级 (Priority)**: High

*   `REQ-FUN-002`: **多光谱数据采集与存储**
    *   **背景与上下文**: 为了分析作物的健康状况，需要捕获特定波段（如近红外、红边）的光谱图像。
    *   **详细描述**: 系统应在飞行过程中，根据预设的触发条件（如到达特定航点或时间间隔），控制多光谱相机进行拍照。采集到的图像数据（每张约5MB，格式为GeoTIFF）应被时间戳和GPS位置标记，并实时通过数传电台传输至地面站。同时，作为备份，数据也应存储在机载的32GB microSD卡中。
    *   **理由 (Rationale)**: 获取关键的农情信息，为精准农业决策提供数据支持。
    *   **验证方法 (Verification)**: Test, Demonstration
    *   **优先级 (Priority)**: High

*   `REQ-FUN-003`: **实时状态监控与遥测**
    *   **背景与上下文**: 操作员需要实时了解无人机的飞行状态和系统健康度，以确保任务安全和有效执行。
    *   **详细描述**: 系统应通过MAVLink协议，以10Hz的频率向地面控制站发送遥测数据包。数据包内容必须包括：GPS位置（经纬度、海拔）、姿态角（滚转、俯仰、偏航）、空速、电池电压（单位：伏特V）、电池剩余电量（单位：百分比%）、电机转速（单位：RPM）和信号链路强度（单位：dBm）。
    *   **理由 (Rationale)**: 为操作员提供态势感知，便于监控和干预。
    *   **验证方法 (Verification)**: Test, Demonstration
    *   **优先级 (Priority)**: High

*   `REQ-FUN-004`: **安全故障处理与自动返航**
    *   **背景与上下文**: 在通信链路丢失或电池电量过低等紧急情况下，系统必须能够自主采取安全措施，防止坠机。
    *   **详细描述**: 当检测到以下任一条件时，系统应自动触发失效保护模式并执行返航着陆（RTL）程序：1) 与地面站的RC控制信号丢失持续超过5秒；2) 电池电压低于预设的3.4V/单体（对于4S电池组，即总电压低于13.6V）。RTL程序包括：爬升至安全高度（预设为50米）、飞向并降落在预设的“家”位置（Home Position）。
    *   **理由 (Rationale)**: 最大限度地保证飞行器本体和地面人员、财产的安全。
    *   **验证方法 (Verification)**: Test, Demonstration
    *   **优先级 (Priority)**: High

### 非功能性需求

*   `REQ-NFN-001`: **飞行控制响应时间**
    *   **背景与上下文**: 为了确保飞行稳定性和对突发气流扰动的抵抗能力，控制回路必须具有极低的延迟。
    *   **详细描述**: 从IMU传感器读取数据到计算并输出PWM信号至电调（ESC）的完整控制回路延迟必须小于10毫秒（ms）。
    *   **理由 (Rationale)**: 快速响应是维持四旋翼无人机姿态稳定的关键，延迟过大会导致振荡甚至失控。
    *   **验证方法 (Verification)**: Test, Analysis
    *   **优先级 (Priority)**: High

*   `REQ-NFN-002`: **系统可靠性**
    *   **背景与上下文**: 农业测绘任务通常在大面积农田上进行，系统故障可能导致任务失败和经济损失。
    *   **详细描述**: 系统在单次30分钟的任务周期内，其关键功能（如飞行控制、通信、动力）的可靠性（可用性）应不低于99.9%。平均故障间隔时间（MTBF）应大于500小时。
    *   **理由 (Rationale)**: 保证任务的成功完成率，降低维护和运营成本。
    *   **验证方法 (Verification)**: Analysis
    *   **优先级 (Priority)**: High

*   `REQ-NFN-003`: **环境适应性**
    *   **背景与上下文**: 无人机需要在户外多变的环境中稳定工作，包括风、温和湿度变化。
    *   **详细描述**: 系统应能在以下环境条件下正常运行：环境温度范围-10°C至45°C；最大抗风能力为10米/秒（约5级风）；防护等级至少为IP54（防尘、防溅水）。
    *   **理由 (Rationale)**: 确保系统在典型的农业作业环境中具备足够的鲁棒性。
    *   **验证方法 (Verification)**: Test
    *   **优先级 (Priority)**: Medium

*   `REQ-NFN-004`: **续航与载重能力**
    *   **背景与上下文**: 续航和载重能力直接决定了单次任务能够覆盖的农田面积和所能搭载的传感器类型。
    *   **详细描述**: 在最大载重5公斤（包括相机、云台等有效载荷）的条件下，系统使用16000mAh 6S锂聚合物电池，应能实现不少于30分钟的有效飞行时间（从起飞到着陆，保留10%的安全电量）。
    *   **理由 (Rationale)**: 满足典型农场单次测绘任务的作业范围需求。
    *   **验证方法 (Verification)**: Test
    *   **优先级 (Priority)**: High

## 2. 系统结构

### 系统顶层架构设计理念
本系统采用分层模块化架构，核心设计原则是功能解耦与高内聚。将系统划分为感知、决策、执行和通信四个逻辑层，以确保各模块职责清晰，接口明确，便于维护、测试和升级。主要功能块依据无人机系统的典型物理和逻辑子系统进行划分。

### 块定义

*   `**FlightControllerUnit**`
    *   **概述 (Overview)**: 作为无人机的大脑，飞行控制器单元负责处理所有传感器数据，运行核心控制算法，并协调所有子系统的行为。它采用高速微处理器，确保控制回路的实时性。
    *   **核心职责 (Core Responsibilities)**:
        *   运行姿态解算算法（如互补滤波或卡尔曼滤波）。
        *   执行位置保持和航点跟踪的PID控制律。
        *   管理飞行状态机并执行失效保护协议。
        *   通过CAN总线与电调通信，通过UART与传感器和通信模块交互。
    *   **关键属性 (Attributes)**: `- currentAttitude: Attitude [degrees] {-180..180}`, `- targetWaypoint: GPS_Coordinate`, `- systemMode: SystemMode {BOOT, STANDBY, MANUAL, AUTO, RTL, FAILSAFE}`
    *   **核心操作 (Operations)**: `- calculateControlOutput(imuData: IMU_Data): PWM_Signal`, `- executeFailsafeAction(failsafeTrigger: FailsafeType): Status`, `- updateStateMachine(event: SystemEvent): void`

*   `**PowerManagementSystem**`
    *   **概述 (Overview)**: 动力管理系统负责为整个无人机提供稳定、可靠的电力供应，并实时监控电池健康状况，它是系统续航和安全的关键。
    *   **核心职责 (Core Responsibilities)**:
        *   通过电源分配板（PDB）将主电池电压分配至各子系统（如电机、飞控、相机）。
        *   通过电池监测电路实时采集电池电压、电流和估算剩余容量。
        *   在低电压或过流情况下触发硬件保护并通知飞控。
    *   **关键属性 (Attributes)**: `- batteryVoltage: Real [V] {0..25.2}`, `- batteryCapacityRemaining: Real [%] {0..100}`, `- totalCurrentDraw: Real [A] {0..60}`
    *   **核心操作 (Operations)**: `- distributePower(load: PowerLoad): Voltage`, `- getBatteryHealth(): BatteryStatus`, `- shutdownPowerRail(rail: PowerRail): void`

*   `**SensorFusionModule**`
    *   **概述 (Overview)**: 传感器融合模块汇集并处理来自多种异构传感器的原始数据，为飞行控制器提供精确、可靠的姿态、位置和速度信息。
    *   **核心职责 (Core Responsibilities)**:
        *   从IMU（包含三轴陀螺仪和三轴加速度计）读取原始数据。
        *   从GPS模块接收位置、速度和时间信息。
        *   从气压计获取高度数据。
        *   运行传感器融合算法（如扩展卡尔曼滤波）以输出最优估计值。
    *   **关键属性 (Attributes)**: `- fusedPosition: GPS_Coordinate`, `- fusedVelocity: Velocity [m/s]`, `- fusedAttitude: Attitude [degrees]`
    *   **核心操作 (Operations)**: `- readIMUData(): IMU_Data`, `- readGPSData(): GPS_Data`, `- runFusionAlgorithm(): FusedNavData`

*   `**PropulsionSystem**`
    *   **概述 (Overview)**: 推进系统是无人机的执行机构，它将飞控的计算指令转化为实际的升力和力矩，通过精确控制四个无刷电机和螺旋桨的转速来实现飞行器的运动。
    *   **核心职责 (Core Responsibilities)**:
        *   接收来自飞控的PWM控制信号。
        *   通过电子调速器（ESC）驱动无刷电机以目标转速旋转。
        *   提供电机转速反馈（如通过霍尔传感器）。
    *   **关键属性 (Attributes)**: `- motorSpeed: Integer [RPM] {0..20000}`, `- motorTemperature: Real [°C] {-40..120}`
    *   **核心操作 (Operations)**: `- setMotorSpeed(pwmSignal: PWM_Signal): void`, `- getMotorTelemetry(): MotorTelemetry`

*   `**DataLinkModule**`
    *   **概述 (Overview)**: 数据链模块是无人机与外部世界（主要是地面控制站）通信的桥梁，负责双向传输控制指令、遥测数据和任务载荷数据。
    *   **核心职责 (Core Responsibilities)**:
        *   通过数传电台（使用900MHz或2.4GHz频段）以MAVLink协议与地面站通信。
        *   通过RC接收机接收来自遥控器的直接操控指令（PPM/SBUS信号）。
        *   加密传输关键指令和数据。
    *   **关键属性 (Attributes)**: `- linkQuality: Real [dBm] {-120..0}`, `- dataRate: Real [kbps] {0..100}`
    *   **核心操作 (Operations)**: `- transmitTelemetry(telemetryData: TelemetryPacket): Status`, `- receiveCommand(): MAVLink_Message`, `- checkRCSignal(): RC_Signal_Status`

*   `**MissionPayload**`
    *   **概述 (Overview)**: 任务载荷是实现无人机特定应用功能的核心，在本系统中特指多光谱相机及其稳定云台，它直接决定了数据产品的质量。
    *   **核心职责 (Core Responsibilities)**:
        *   根据飞控或地面站的指令控制相机进行拍照或录像。
        *   通过云台伺服机构稳定相机，抵消飞行器姿态变化带来的抖动。
        *   预处理采集到的图像数据（如压缩、添加元数据）。
        *   管理机载存储设备。
    *   **关键属性 (Attributes)**: `- cameraTriggerInterval: Real [s] {0.1..10.0}`, `- gimbalOrientation: Attitude [degrees] {-180..180}`, `- storageUsage: Real [GB] {0..32}`
    *   **核心操作 (Operations)**: `- captureImage(): ImageData`, `- stabilizeGimbal(attitudeRef: Attitude): void`, `- transferDataToStorage(image: ImageData): Status`

### 内部结构与交互原理

*   `**上下文**: UAV_System（无人机系统）`
    *   **设计阐述**: 无人机系统的内部设计围绕飞行控制器单元（FCU）这一核心展开。FCU通过高速内部总线（如SPI、I2C）与传感器模块紧密交互，获取导航信息；通过CAN总线向推进系统发送高频率控制指令，确保动力响应的实时性；通过UART与数据链和任务载荷通信，管理相对低速但关键的任务与通信数据。电源管理系统作为基础支撑，通过专用的电源线和模拟信号线与所有用电模块连接，实现供电与监控。这种星型与总线混合的拓扑结构，兼顾了性能、可靠性和可扩展性。
    *   **组成部分 (Parts)**: `fc1: FlightControllerUnit`, `pms1: PowerManagementSystem`, `sfm1: SensorFusionModule`, `ps1: PropulsionSystem`, `dlm1: DataLinkModule`, `mp1: MissionPayload`
    *   **连接关系 (Connectors)**:
        *   `[sfm1.navDataPort] <--> [fc1.sensorInputPort]` (传输融合后的导航数据)
        *   `[fc1.motorControlPort] --CAN--> [ps1.escCommandPort]` (传输电机控制指令)
        *   `[pms1.powerOut] --Power Cable--> [fc1.powerIn], [ps1.powerIn], ...` (分配电力)
        *   `[pms1.batteryTelemetryPort] <--> [fc1.telemetryInputPort]` (传输电池状态)
        *   `[dlm1.commandOutputPort] <--> [fc1.commandInputPort]` (传输来自地面的指令)
        *   `[fc1.telemetryOutputPort] <--> [dlm1.telemetryInputPort]` (传输遥测数据)
        *   `[fc1.payloadCommandPort] <--> [mp1.controlPort]` (传输载荷控制指令)
        *   `[mp1.dataOutputPort] <--> [dlm1.payloadDataInputPort]` (传输图像数据至数传)

## 3. 活动流程

*   `**活动名称**: 自主测绘任务执行流程`
*   **流程概述**: 此流程描述了无人机从接收到地面站发出的“开始任务”指令，到完成预定航线的测绘并返回待机状态的完整自动化过程。它涵盖了航点导航、数据采集触发和状态监控等关键环节，是实现核心功能的主要工作流。
*   **输入/输出 (Parameters)**: `IN: start_mission_command: MAVLink_Command`, `mission_plan: FlightPlan`, `OUT: mission_status: MissionReport`, `collected_imagery: ImageDataSet`
*   **步骤序列 (Actions)**:
    1.  **验证指令与计划**: 飞行控制器接收并解析“开始任务”指令，检查飞行计划的完整性和有效性（如航点数量、安全高度）。
    2.  **解锁电机并起飞**: 飞控向推进系统发送解锁信号，随后控制电机转速使无人机垂直起飞至第一个航点的起始高度。
    3.  **导航至下一航点**: 飞控根据传感器融合模块提供的实时位置，计算与目标航点的偏差，并运行PID控制器生成电机控制指令，驱使无人机飞向目标。
    4.  **检查航点到达条件**: 当无人机进入以目标航点为中心、半径为5米的范围内时，判定为到达该航点。
    5.  **触发数据采集**: 在到达航点时，飞控通过任务载荷控制端口发送“拍照”指令。任务载荷模块执行拍照操作，并为图像添加GPS坐标和时间戳。
    6.  **数据传输与存储**: 采集到的图像数据通过数据链模块尝试实时下传，同时被写入机载存储。
    7.  **循环执行**: 重复步骤3至6，直至飞行计划中的所有航点都被访问完毕。
    8.  **执行返航着陆**: 飞控触发“返航”指令，无人机爬升至安全高度（50米），飞向Home位置并执行自动着陆序列。
    9.  **任务结束报告**: 着陆并上锁电机后，飞控生成任务报告（包括完成的航点数、采集的图像数、飞行时间等），并通过数据链发送至地面站。

## 4. 状态机行为

*   `**上下文块**: FlightControllerUnit`
*   **行为模型概述**: 飞行控制器的行为模型定义了无人机从物理上电到任务结束下电的完整生命周期。该模型以状态为核心，清晰地划分了系统在不同阶段的行为模式和允许的操作。主要状态包括初始化、地面准备、手动操控、自动任务执行以及处理各种紧急情况的失效保护状态，确保了系统行为的可预测性和安全性。
*   **状态定义**:
    *   `**状态名称**: INIT`
        *   **描述**: 系统刚上电，正在进行硬件自检和软件初始化。
        *   `entry / initializeHardware(); loadParametersFromEEPROM()`
        *   `do / 运行内置测试（BIT），检查传感器、通信链路是否正常`
        *   `exit / 无`
    *   `**状态名称**: STANDBY`
        *   **描述**: 系统初始化完成，电机未上锁，等待用户指令。
        *   `entry / 启动遥测数据流发送`
        *   `do / 持续监控遥控器信号和地面站指令`
        *   `exit / 无`
    *   `**状态名称**: MANUAL`
        *   **描述**: 无人机由操作员通过遥控器直接控制飞行。
        *   `entry / 解锁电机；切换到手动控制模式`
        *   `do / 将RC接收机的PPM/SBUS信号映射为姿态角或油门指令`
        *   `exit / 上锁电机`
    *   `**状态名称**: AUTO_MISSION`
        *   **描述**: 无人机正在自动执行预定义的飞行计划（航点跟踪）。
        *   `entry / 载入飞行计划；启动航点跟踪控制器`
        *   `do / 持续运行导航和控制算法，跟踪预定航线`
        *   `exit / 停止航点跟踪控制器`
    *   `**状态名称**: RETURN_TO_LAUNCH`
        *   **描述**: 系统正在执行自动返航并着陆程序。
        *   `entry / 记录当前状态；命令无人机爬升至RTL安全高度`
        *   `do / 导航至Home位置；在Home点上方执行着陆程序`
        *   `exit / 上锁电机；切换至STANDBY状态`
    *   `**状态名称**: FAILSAFE`
        *   **描述**: 系统检测到严重故障（如电量极低、通信完全丢失），正在执行最高优先级的保护动作。
        *   `entry / 记录故障码；中止当前任何任务`
        *   `do / 根据具体的故障类型执行预设的应对策略（如立即着陆、悬停）`
        *   `exit / 仅在故障条件解除且收到外部复位指令后退出`
    *   `**状态名称**: LANDED`
        *   **描述**: 无人机已成功着陆，电机已上锁，但系统仍未断电。
        *   `entry / 上锁电机；发送"Landed"状态消息`
        *   `do / 继续保持传感器数据和遥测发送`
        *   `exit / 无`
*   **转换 (Transitions)**:
    *   `[INIT] --[BIT_Passed] / reportStatus("Ready")--> [STANDBY]`
    *   `[STANDBY] --[RC_Armed_Signal] / armMotors()--> [MANUAL]`
    *   `[STANDBY] --[GCS_Auto_Command] / loadMission()--> [AUTO_MISSION]`
    *   `[MANUAL] --[RC_Disarmed_Signal] / disarmMotors()--> [STANDBY]`
    *   `[AUTO_MISSION] --[Mission_Complete] / reportMissionComplete()--> [RETURN_TO_LAUNCH]`
    *   `[任何状态] --[Low_Battery_Alert[batteryVoltage < 13.6V]] / triggerFailsafe(LOW_BATTERY)--> [FAILSAFE]`
    *   `[任何状态] --[RC_Signal_Lost[time > 5s]] / triggerFailsafe(RC_LOST)--> [RETURN_TO_LAUNCH]`
    *   `[RETURN_TO_LAUNCH] --[Vehicle_Landed] / disarmMotors()--> [LANDED]`
    *   `[LANDED] --[GCS_Disarm_Command]--> [STANDBY]`

## 5. 用例场景

*   `**用例名称**: 执行农田测绘任务`
*   **场景简述 (Narrative)**: 农业技术员李四需要对一块500亩的玉米地进行生长状况评估。他首先在办公室使用地面站软件规划好详细的飞行航线，并设置好多光谱相机的拍摄间隔。到达田间后，他选择一块平坦安全的区域作为起降场，启动无人机。无人机自动起飞，严格按照规划航线飞行，并在每个航点自动拍照。李四通过平板电脑上的地面站软件实时查看无人机位置和电池状态。任务完成后，无人机自动返回并降落在起降点。李四回收无人机，导出数据用于后续分析。
*   **参与者 (Actors)**: `Primary: 农业技术员`, `Secondary: 地面控制站软件`
*   **基本流程 (Happy Path)**:
    1.  技术员通过地面站上传飞行计划至无人机。
    2.  技术员在安全环境下发出"自动起飞"指令。
    3.  无人机起飞并开始按航线飞行。
    4.  无人机在每个航点自动触发相机拍照。
    5.  无人机完成所有航点后自动返航并着陆。
    6.  技术员确认任务完成，下载数据。
*   **备选/异常流程**:
    *   **通信中断**: 如果在任务中与地面站的数传链路中断，无人机将根据预设策略（见状态机）继续完成任务或执行返航。
    *   **电量不足**: 如果在任务中途电池电量低于安全阈值，无人机将立即中止任务，并自动返航。
    *   **恶劣天气**: 技术员通过地面站监控到风速过大，手动发送指令中止任务，命令无人机立即返航。

## 6. 参数关系

*   `**约束块**: FlightTimeEstimation`
*   **物理意义与应用**: 此约束用于在任务规划阶段估算无人机的最大飞行时间。它基于电池的总可用能量和系统的平均功率消耗，是评估任务可行性和规划航线长度的关键依据。
*   **参数 (Parameters)**: `TotalBatteryCapacity: Real [mAh]`, `AveragePowerConsumption: Real [W]`, `BatteryVoltage: Real [V]`, `EstimatedFlightTime: Real [minutes]`
*   **约束公式 (Constraint)**:
    *   `TotalUsableEnergy [Wh] = (TotalBatteryCapacity [mAh] * BatteryVoltage [V]) / 1000 * 0.9` (假设保留10%安全电量)
    *   `EstimatedFlightTime [minutes] = (TotalUsableEnergy [Wh] / AveragePowerConsumption [W]) * 60`

*   `**约束块**: MaximumLiftConstraint`
*   **物理意义与应用**: 该约束确保推进系统产生的总升力足以克服无人机自身的重力及其所承载的有效载荷，是保证飞行安全和实现载重指标的根本物理原理。
*   **参数 (Parameters)**: `TotalThrust: Real [N]`, `UAV_Mass: Real [kg]`, `Payload_Mass: Real [kg]`, `Gravity: Real [m/s^2] = 9.81`
*   **约束公式 (Constraint)**:
    *   `TotalThrust >= (UAV_Mass + Payload_Mass) * Gravity`

## 7. 交互序列

*   `**场景名称**: 处理低电量紧急情况`
*   **交互背景**: 本序列描述了当动力管理系统的电池监测电路检测到电压低于安全阈值时，系统内部各组件如何协同工作，触发并执行自动返航安全程序的完整过程。此交互确保了在能源危机下的系统安全。
*   **涉及的生命线 (Lifelines)**: `[PowerManagementSystem]`, `[FlightControllerUnit]`, `[DataLinkModule]`, `[PropulsionSystem]`
*   **消息序列 (Messages)**:
    1.  `[PowerManagementSystem] -> [FlightControllerUnit]: BatteryAlert(LOW_VOLTAGE, voltage=13.5V)` (周期性地发送电池状态，当电压低于阈值时告警)
    2.  `[FlightControllerUnit] -> [FlightControllerUnit]: evaluateCondition()` (飞控内部逻辑判断触发失效保护条件)
    3.  `[FlightControllerUnit] -> [DataLinkModule]: sendTelemetry(STATUS_CRITICAL, "Low Battery RTL Triggered")` (立即向地面站发送紧急状态通知)
    4.  `[FlightControllerUnit] -> [FlightControllerUnit]: transitionTo(RETURN_TO_LAUNCH)` (飞控状态机切换到返航状态)
    5.  `[FlightControllerUnit] -> [PropulsionSystem]: setMotorSpeed(Climb_PWM)` (控制无人机爬升至RTL安全高度)
    6.  `[FlightControllerUnit] -> [PropulsionSystem]: setMotorSpeed(Navigate_To_Home_PWM)` (控制无人机飞向Home点)
    7.  `[FlightControllerUnit] -> [DataLinkModule]: sendTelemetry(POSITION_DATA)` (持续发送位置信息，让地面站了解返航进度)
    8.  `[FlightControllerUnit] -> [PropulsionSystem]: setMotorSpeed(Landing_Sequence_PWM)` (在Home点上方执行着陆程序)
    9.  `[PropulsionSystem] -> [FlightControllerUnit]: MotorTelemetry(rpm=0)` (着陆后，电机停转)
    10. `[FlightControllerUnit] -> [DataLinkModule]: sendTelemetry(STATUS_OK, "Landed Safely")` (发送安全着陆确认消息)