# 无人驾驶汽车系统设计文档

## 1. 需求规格

### 功能性需求

**REQ-FUN-001: 环境感知与障碍物检测**
- **背景与上下文**: 为确保车辆在各种道路环境下安全行驶，系统必须能够实时感知周围环境并准确识别障碍物。
- **详细描述**: 系统应通过多传感器融合（激光雷达、摄像头、毫米波雷达）检测车辆周围360度范围内的静态和动态障碍物，包括其他车辆、行人、交通标志等，检测距离范围0.5-150米，检测精度≥99%。
- **理由**: 这是实现安全自动驾驶的基础能力，直接影响避障和路径规划决策。
- **验证方法**: Test
- **优先级**: High

**REQ-FUN-002: 高精度定位与地图匹配**
- **背景与上下文**: 为实现精确的路径规划和导航，系统需要准确知道自身在道路网络中的位置。
- **详细描述**: 系统应结合GPS（精度≤10cm）、IMU和激光雷达点云数据，实现车辆在HD地图中的精确定位，横向定位误差≤15cm，纵向定位误差≤20cm。
- **理由**: 精确定位是路径规划和车道保持的前提条件。
- **验证方法**: Test
- **优先级**: High

**REQ-FUN-003: 实时路径规划与决策**
- **背景与上下文**: 车辆需要根据当前环境和目的地，实时规划最优行驶路径并做出驾驶决策。
- **详细描述**: 系统应基于A*或RRT*算法，每100ms重新规划一次路径，考虑交通规则、障碍物位置和车辆动力学约束，规划延迟≤50ms。
- **理由**: 实时路径规划确保车辆能够及时应对动态变化的交通环境。
- **验证方法**: Test
- **优先级**: High

**REQ-FUN-004: 车辆运动控制**
- **背景与上下文**: 系统需要将规划路径转化为具体的车辆控制指令，实现精确的横向和纵向控制。
- **详细描述**: 系统应通过PID控制器或MPC控制器，控制车辆的转向、油门和制动，实现车道保持误差≤10cm，速度控制精度±1km/h。
- **理由**: 精确的运动控制是实现自动驾驶操作的基础。
- **验证方法**: Test
- **优先级**: High

### 非功能性需求

**REQ-NFN-001: 系统响应时间**
- **背景与上下文**: 为确保行车安全，系统必须在极短时间内完成从感知到控制的完整决策循环。
- **详细描述**: 从传感器数据采集到执行器控制输出的端到端延迟≤100ms，感知-决策-控制环路频率≥20Hz。
- **理由**: 快速响应是避免碰撞和处理紧急情况的关键。
- **验证方法**: Test
- **优先级**: High

**REQ-NFN-002: 系统可靠性**
- **背景与上下文**: 自动驾驶系统必须保证在恶劣环境和部件故障情况下的持续可靠运行。
- **详细描述**: 系统应达到ASIL-D功能安全等级，平均无故障时间(MTBF)≥10,000小时，关键子系统采用冗余设计。
- **理由**: 高可靠性是保障乘客和道路安全的基本要求。
- **验证方法**: Analysis
- **优先级**: High

**REQ-NFN-003: 计算性能**
- **背景与上下文**: 实时处理大量传感器数据需要强大的计算能力支持。
- **详细描述**: 主计算单元应具备≥50 TOPS的AI推理性能，内存带宽≥200GB/s，支持并行处理多路传感器数据流。
- **理由**: 足够的计算性能是保证系统实时性的基础。
- **验证方法**: Analysis
- **优先级**: High

## 2. 系统结构

### 系统顶层架构设计理念
本系统采用分层模块化架构，遵循高内聚低耦合的设计原则。整体架构分为感知层、决策层和控制层三个主要层次，各层之间通过标准化的接口进行通信。系统采用基于ROS 2的中间件实现组件间通信，确保实时性和可靠性。

### 块定义

**PerceptionSystem**
- **概述**: 感知系统负责处理所有传感器数据，构建车辆周围环境的实时模型。它采用多传感器融合技术，结合激光雷达、摄像头和雷达数据，提供准确的环境感知信息。
- **核心职责**: 
  - 处理激光雷达点云数据
  - 执行视觉目标检测与识别
  - 融合多传感器信息
  - 跟踪动态障碍物
- **关键属性**: 
  - `detectionRange: Real [m] {0.5..150}`
  - `processingLatency: Real [ms] {0..50}`
  - `objectDetectionConfidence: Real [%] {0..100}`
- **核心操作**: 
  - `processSensorData(sensorData: SensorData): PerceptionOutput`
  - `fuseMultiSensorData(): FusedPerceptionData`
  - `trackObjects(): ObjectTrackList`

**LocalizationModule**
- **概述**: 定位模块负责精确确定车辆在全局坐标系中的位置和姿态，结合GPS、IMU和激光雷达数据，实现厘米级定位精度。
- **核心职责**:
  - 融合GPS和IMU数据
  - 执行激光雷达点云匹配
  - 提供车辆6自由度位姿
- **关键属性**:
  - `positionAccuracy: Real [cm] {0..20}`
  - `updateRate: Real [Hz] {10..100}`
  - `headingAccuracy: Real [deg] {0..1}`
- **核心操作**:
  - `estimatePose(): VehiclePose`
  - `matchPointCloud(mapData: PointCloud): LocalizationResult`
  - `correctDrift(sensorData: SensorData): CorrectedPose`

**PlanningSystem**
- **概述**: 规划系统基于感知和定位信息，实时生成安全可行的行驶路径。它采用分层规划策略，从全局路径到局部轨迹层层细化。
- **核心职责**:
  - 全局路径规划
  - 局部轨迹生成
  - 行为决策
- **关键属性**:
  - `planningHorizon: Real [m] {10..200}`
  - `replanningRate: Real [Hz] {5..20}`
  - `collisionCheckDistance: Real [m] {5..50}`
- **核心操作**:
  - `generateGlobalRoute(destination: GeoPoint): Route`
  - `computeLocalTrajectory(): Trajectory`
  - `makeBehaviorDecision(): BehaviorCommand`

**ControlSystem**
- **概述**: 控制系统将规划轨迹转化为具体的车辆控制指令，通过精确的横向和纵向控制实现轨迹跟踪。
- **核心职责**:
  - 横向控制（转向）
  - 纵向控制（油门/制动）
  - 轨迹跟踪
- **关键属性**:
  - `controlFrequency: Real [Hz] {50..200}`
  - `trackingError: Real [cm] {0..15}`
  - `actuatorDelay: Real [ms] {0..20}`
- **核心操作**:
  - `computeSteeringCommand(): SteeringAngle`
  - `computeThrottleCommand(): ThrottleValue`
  - `computeBrakeCommand(): BrakePressure`

**VehicleInterface**
- **概述**: 车辆接口模块负责与车辆底层系统的通信，将控制指令转换为CAN总线消息，同时读取车辆状态信息。
- **核心职责**:
  - 控制指令下发
  - 车辆状态监控
  - CAN总线通信
- **关键属性**:
  - `canBusRate: Real [kbps] {125..1000}`
  - `sensorUpdateRate: Real [Hz] {10..100}`
  - `actuatorResponseTime: Real [ms] {0..50}`
- **核心操作**:
  - `sendControlCommands(commands: ControlSet): Status`
  - `readVehicleState(): VehicleState`
  - `monitorSystemHealth(): HealthStatus`

### 内部结构与交互原理

**上下文**: AutonomousDrivingSystem
- **设计阐述**: 主系统内部采用星型通信架构，中央决策协调器作为核心，各功能模块通过标准接口与协调器通信。这种设计确保了系统的可扩展性和模块独立性，便于后续的功能升级和维护。
- **组成部分**:
  - `perception: PerceptionSystem`
  - `localization: LocalizationModule` 
  - `planning: PlanningSystem`
  - `control: ControlSystem`
  - `vehicleIf: VehicleInterface`
  - `coordinator: SystemCoordinator`
- **连接关系**:
  - `[perception.perceptionOutput] <--> [coordinator.perceptionInput]`
  - `[localization.poseOutput] <--> [coordinator.localizationInput]`
  - `[coordinator.planningRequest] <--> [planning.planningInput]`
  - `[planning.trajectoryOutput] <--> [coordinator.trajectoryInput]`
  - `[coordinator.controlCommand] <--> [control.controlInput]`
  - `[control.actuatorCommand] <--> [vehicleIf.commandInput]`

## 3. 活动流程

**活动名称**: 自动驾驶主循环流程
- **流程概述**: 此流程描述了自动驾驶系统从传感器数据采集到控制指令输出的完整处理循环，是系统实现实时自动驾驶的核心业务流程。每个循环周期为50ms，确保系统能够及时响应环境变化。
- **输入/输出**: 
  - IN: `sensor_data: MultiSensorData`
  - OUT: `control_commands: ActuatorCommands`
- **步骤序列**:
  1. 接收多传感器数据（激光雷达、摄像头、雷达）
  2. 执行传感器数据预处理和时间同步
  3. 并行执行环境感知和车辆定位
  4. 融合感知和定位结果，构建环境模型
  5. 基于环境模型进行行为决策和路径规划
  6. 生成平滑的局部轨迹
  7. 计算轨迹跟踪控制指令
  8. 验证控制指令安全性
  9. 通过车辆接口下发控制指令
  10. 监控执行结果并记录日志

## 4. 状态机行为

**上下文块**: AutonomousDrivingController
- **行为模型概述**: 自动驾驶控制器状态机定义了系统从启动到关机的完整生命周期，包括各种驾驶模式和故障处理状态。状态转换基于用户指令、系统条件和环境因素，确保系统在不同场景下都能安全可靠地运行。
- **状态定义**:

**状态名称**: INIT
- **描述**: 系统初始化状态，进行自检和组件准备
- `entry / initializeComponents()`
- `do / performSelfTest()`
- `exit / logInitializationResult()`

**状态名称**: STANDBY
- **描述**: 系统就绪状态，等待用户指令
- `entry / enableSensors()`
- `do / monitorSystemStatus()`
- `exit / prepareForEngagement()`

**状态名称**: AUTONOMOUS_DRIVING
- **描述**: 全自动驾驶模式，系统完全控制车辆
- `entry / activateAutonomousMode()`
- `do / executeDrivingLoop()`
- `exit / disengageAutonomousControl()`

**状态名称**: MANUAL_OVERRIDE
- **描述**: 人工接管状态，驾驶员控制车辆
- `entry / transferControlToDriver()`
- `do / monitorDriverInput()`
- `exit / prepareAutonomousResume()`

**状态名称**: EMERGENCY_STOP
- **描述**: 紧急停止状态，系统执行安全停车
- `entry / triggerEmergencyBraking()`
- `do / maintainSafeStop()`
- `exit / assessSituation()`

**状态名称**: FAULT
- **描述**: 系统故障状态，进行故障处理和恢复
- `entry / enterSafeState()`
- `do / diagnoseFault()`
- `exit / executeRecoveryProcedure()`

- **转换**:
  - `[INIT] --[selfTestPassed]--> [STANDBY]`
  - `[STANDBY] --[autonomousEngage]--> [AUTONOMOUS_DRIVING]`
  - `[AUTONOMOUS_DRIVING] --[driverOverride]--> [MANUAL_OVERRIDE]`
  - `[AUTONOMOUS_DRIVING] --[criticalFault]--> [EMERGENCY_STOP]`
  - `[MANUAL_OVERRIDE] --[autonomousResume]--> [AUTONOMOUS_DRIVING]`
  - `[任何状态] --[systemFault[severity > threshold]]--> [FAULT]`
  - `[EMERGENCY_STOP] --[situationResolved]--> [STANDBY]`

## 5. 用例场景

**用例名称**: 城市道路自动驾驶
- **场景简述**: 用户设定目的地后启动自动驾驶功能，车辆在复杂的城市道路环境中自动行驶，处理交通信号、交叉路口、行人穿越等各种典型场景，最终安全到达目的地。
- **参与者**: 
  - Primary: 乘客
  - Secondary: 交通管理系统、其他道路使用者
- **基本流程**:
  1. 乘客通过人机界面设定目的地
  2. 系统规划全局路径并确认
  3. 乘客启动自动驾驶模式
  4. 系统执行环境感知和定位
  5. 根据交通状况实时调整行驶策略
  6. 处理交叉路口和交通信号
  7. 避让行人和障碍物
  8. 到达目的地后自动停车
- **备选/异常流程**:
  - 如遇施工路段，系统重新规划绕行路径
  - 如传感器故障，系统降级运行或请求人工接管
  - 如通信中断，系统依靠本地感知继续安全行驶

## 6. 参数关系

**约束块**: VehicleDynamicsConstraint
- **物理意义与应用**: 此约束描述了车辆运动学与动力学的基本关系，用于确保规划轨迹的物理可行性和乘坐舒适性。它考虑了车辆的最大加速度、转向几何约束和轮胎摩擦极限。
- **参数**:
  - `max_lateral_acceleration: Real [m/s²] = 3.0`
  - `max_longitudinal_acceleration: Real [m/s²] = 4.0`
  - `max_deceleration: Real [m/s²] = 6.0`
  - `wheelbase: Real [m] = 2.8`
  - `max_steering_angle: Real [deg] = 30.0`
- **约束公式**:
  - 最小转弯半径: `min_turning_radius = wheelbase / tan(max_steering_angle)`
  - 最大曲率约束: `trajectory_curvature ≤ 1 / min_turning_radius`
  - 加速度约束: `longitudinal_acceleration² + lateral_acceleration² ≤ max_total_acceleration²`

## 7. 交互序列

**场景名称**: 前方障碍物避让
- **交互背景**: 当感知系统检测到前方有静止障碍物时，系统需要快速做出反应，规划避让路径并执行相应的控制动作。此序列展示了从障碍物检测到完成避让的完整组件协作过程。
- **涉及的生命线**: 
  - `PerceptionSystem`
  - `PlanningSystem` 
  - `ControlSystem`
  - `VehicleInterface`
- **消息序列**:
  1. PerceptionSystem -> PlanningSystem: `obstacleDetected(obstacle_info)`
  2. PlanningSystem -> PlanningSystem: `replanTrajectory()`
  3. PlanningSystem -> ControlSystem: `newTrajectory(trajectory_data)`
  4. ControlSystem -> ControlSystem: `computeControlCommands()`
  5. ControlSystem -> VehicleInterface: `steeringCommand(angle)`
  6. ControlSystem -> VehicleInterface: `speedCommand(speed)`
  7. VehicleInterface -> ControlSystem: `commandAck(status)`
  8. PerceptionSystem -> PlanningSystem: `obstacleCleared()`