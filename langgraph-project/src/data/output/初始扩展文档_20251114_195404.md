# 无人机系统设计文档

## 1. 需求规格

**上下文说明**: 本系统设计针对一款用于农业测绘的四旋翼无人机，要求续航时间不低于30分钟，有效载重5公斤，集成高分辨率多光谱相机，能够在复杂农田环境中自主执行测绘任务。

### 功能性需求

`REQ-FUN-001`: 自主飞行控制
*   **背景与上下文**: 无人机需要在没有持续人工干预的情况下执行预定义的飞行路径，以适应大面积农田测绘的效率需求。
*   **详细描述**: 系统应能接收并解析来自地面控制站的飞行计划（包含航点坐标、高度、速度参数），通过集成GPS（精度<2米）和惯性测量单元（IMU）实现三维空间内的稳定飞行和精确定位，航点跟踪误差应小于1米。
*   **理由 (Rationale)**: 自主飞行是提高测绘作业效率、减少人为操作错误的核心能力。
*   **验证方法 (Verification)**: Test
*   **优先级 (Priority)**: High

`REQ-FUN-002`: 多光谱数据采集
*   **背景与上下文**: 现代农业测绘需要获取作物在不同波段的光谱信息以分析其健康状况，单一可见光相机无法满足此需求。
*   **详细描述**: 系统应控制搭载的多光谱相机（涵盖蓝、绿、红、红边、近红外五个波段）按预设间隔或位置自动触发拍摄，采集的图像数据（分辨率至少1280x960像素/波段）需附带时间戳、GPS坐标和飞行姿态数据，并实时传输至机载存储单元。
*   **理由 (Rationale)**: 高质量的多光谱数据是进行精准农业分析的基础。
*   **验证方法 (Verification)**: Test
*   **优先级 (Priority)**: High

`REQ-FUN-003`: 动力系统管理与监测
*   **背景与上下文**: 确保飞行安全与达到设计的续航时间，需要对整个动力链进行实时监控和智能管理。
*   **详细描述**: 系统应持续监测电池组电压（标称22.2V）、电流（0-40A）和剩余电量（%），并估算剩余飞行时间。当电量低于20%或电压低于警戒值（18V）时，应自动触发返航流程。同时，需控制无刷电机的转速（1000-10000 RPM）。
*   **理由 (Rationale)**: 有效的动力管理是保证飞行安全和任务成功的关键。
*   **验证方法 (Verification)**: Test, Demonstration
*   **优先级 (Priority)**: High

`REQ-FUN-004`: 应急处理与故障保护
*   **背景与上下文**: 在飞行过程中可能遇到GPS信号丢失、通讯中断或动力不足等异常情况，系统必须具备自主应对能力以防止坠机。
*   **详细描述**: 在检测到GPS信号丢失超过10秒时，系统应切换至纯惯性导航或视觉辅助导航模式。若与地面站的通讯链路中断超过15秒，应自动执行预设的应急程序（如悬停、返航或降落）。当任何电机或电调被检测到故障时，应尽力维持姿态并尝试迫降。
*   **理由 (Rationale)**: 最大限度地保证飞行器与地面人员、财产的安全。
*   **验证方法 (Verification)**: Test, Analysis
*   **优先级 (Priority)**: High

### 非功能性需求

`REQ-NFN-001`: 控制系统响应时间
*   **背景与上下文**: 为了确保飞行稳定性和对突发状况（如阵风）的快速反应，飞行控制回路必须具有极低的延迟。
*   **详细描述**: 从IMU采集姿态数据到计算出电机PWM控制信号的整个闭环周期必须小于5ms。对于来自地面站的新指令，系统响应并开始执行的动作延迟应小于100ms。
*   **理由 (Rationale)**: 低延迟是维持飞行器稳定，尤其是在抗风扰方面的决定性因素。
*   **验证方法 (Verification)**: Test, Analysis
*   **优先级 (Priority)**: High

`REQ-NFN-002`: 通讯链路可靠性
*   **背景与上下文**: 无人机与地面站之间需要稳定可靠的数据交换，以传输控制指令、遥测数据和采集的图像。
*   **详细描述**: 在视距范围内（最大2公里），数据链路的通信成功率应大于99.9%。控制指令采用高优先级的传输通道，确保在信道拥堵时优先送达。使用跳频技术抗干扰。
*   **理由 (Rationale)**: 可靠的通讯是保证控制有效性和数据完整性的基石。
*   **验证方法 (Verification)**: Test
*   **优先级 (Priority)**: High

`REQ-NFN-003`: 环境适应性
*   **背景与上下文**: 农业测绘作业环境多样，可能面临风、雨、尘等挑战。
*   **详细描述**: 无人机应能在风速不超过10m/s（5级风）的条件下稳定飞行。系统（特别是传感器接口）应具备基本的防尘和防轻微水溅（IP54等级）能力。工作温度范围应覆盖-10°C 至 45°C。
*   **理由 (Rationale)**: 适应典型的野外作业环境，保证任务的出勤率和完成率。
*   **验证方法 (Verification)**: Test, Analysis
*   **优先级 (Priority)**: Medium

`REQ-NFN-004`: 续航与载重能力
*   **背景与上下文**: 续航和载重能力直接决定了单次飞行所能覆盖的测绘面积和所能搭载的传感器类型。
*   **详细描述**: 在搭载5公斤有效载荷（包括相机、云台等）的前提下，无人机悬停时间不得少于25分钟，总续航时间应达到30分钟。最大起飞重量不得超过15公斤。
*   **理由 (Rationale)**: 满足典型农田区块的单次测绘任务需求。
*   **验证方法 (Verification)**: Test, Demonstration
*   **优先级 (Priority)**: High

## 2. 系统结构

### 系统顶层架构设计理念
本系统采用分层-模块化的混合架构，核心设计原则是功能解耦与接口标准化。顶层划分为感知层、决策层、执行层和通讯层。感知层负责收集内外环境数据；决策层（飞行控制器为核心）进行数据融合与决策；执行层控制动力和负载；通讯层管理内外数据交换。这种划分确保了各模块的高内聚与低耦合，便于测试、维护和升级。

### 块定义 (Block Definition)

`**FlightController**`
*   **概述 (Overview)**: 作为无人机的大脑，该模块负责融合来自多种传感器的数据，运行核心控制算法（如PID控制器），并生成对动力系统和任务负载的控制指令。其设计理念是提供稳定、可靠且高效的计算平台，确保系统实时响应。
*   **核心职责 (Core Responsibilities)**:
    *   运行姿态解算与飞行控制算法
    *   执行飞行任务管理与导航
    *   进行传感器数据融合（GPS， IMU， 气压计）
    *   协调各子系统间的交互
*   **关键属性 (Attributes)**:
    *   `- currentAttitude: Orientation {roll: -45..45 [deg], pitch: -45..45 [deg], yaw: 0..360 [deg]}`
    *   `- flightMode: FlightModeEnum {MANUAL, GPS_HOLD, AUTO}`
    *   `- cpuLoad: Real [%] {0..100}`
*   **核心操作 (Operations)**:
    *   `- calculateControlOutput(targetAttitude: Orientation): PWMCommand`
    *   `- executeMission(missionPlan: WaypointList): Status`
    *   `- handleSystemFault(faultCode: Integer): EmergencyAction`

`**PowerManagementUnit**`
*   **概述 (Overview)**: 该模块是无人机的心脏，负责管理能源的分配、监测和智能调度。设计上采用冗余监控电路，确保在任何单点故障下都能提供关键的系统状态信息，并执行安全策略。
*   **核心职责 (Core Responsibilities)**:
    *   监测高压锂电池组的电压、电流和温度
    *   估算电池剩余电量和续航时间
    *   为各子系统（动力、飞控、负载）分配电力
    *   执行低电量保护与优先断电逻辑
*   **关键属性 (Attributes)**:
    *   `- batteryVoltage: Real [V] {0..25.2}`
    *   `- batteryCapacityRemaining: Real [%] {0..100}`
    *   `- totalCurrentDraw: Real [A] {0..50}`
*   **核心操作 (Operations)**:
    *   `- getBatteryHealth(): HealthStatus`
    *   `- distributePower(loadPriority: LoadPriorityEnum): Boolean`
    *   `- initiateSafeShutdown(): void`

`**SensorFusionModule**`
*   **概述 (Overview)**: 该模块是无人机的感官系统，负责从分散的传感器中采集原始数据，并通过算法（如卡尔曼滤波）进行融合，为飞行控制器提供准确、平滑且可靠的状态估计。
*   **核心职责 (Core Responsibilities)**:
    *   采集并预处理IMU（加速度计、陀螺仪）、GPS、磁力计和气压计数据
    *   运行传感器融合算法以估算位置、速度、姿态
    *   提供视觉里程计或激光测距等辅助导航数据（如可用）
*   **关键属性 (Attributes)**:
    *   `- fusedPosition: Coordinates {lat: Real, lon: Real, alt: Real [m]}`
    *   `- fusedVelocity: Vector3D [m/s]`
    *   `- sensorHealth: Map<SensorType, HealthStatus>`
*   **核心操作 (Operations)**:
    *   `- kalmanFilterUpdate(rawIMU: IMUData, rawGPS: GPSData): FusedState`
    *   `- calibrateSensors(): CalibrationStatus`

`**PropulsionSystem**`
*   **概述 (Overview)**: 该模块是无人机的肌肉，将控制指令转化为实际的升力和推力。其设计强调响应速度和可靠性，通过四个独立的无刷电机和电子调速器（ESC）实现六自由度的姿态控制。
*   **核心职责 (Core Responsibilities)**:
    *   接收飞行控制器的PWM指令并驱动电机
    *   监测各电机和ESC的运行状态（转速、温度）
    *   实现电机的同步启动与急停
*   **关键属性 (Attributes)**:
    *   `- motorRPM: Real [RPM] {0..12000}`
    *   `- escTemperature: Real [°C] {-40..120}`
*   **核心操作 (Operations)**:
    *   `- setMotorSpeed(motorID: Integer, pwmValue: Integer): Boolean`
    *   `- getMotorTelemetry(): MotorTelemetryData`

`**CommunicationModule**`
*   **概述 (Overview)**: 该模块是无人机与外部世界（主要是地面控制站）的桥梁，负责建立和维护可靠的数据链路。设计上采用双频段（如2.4GHz用于控制，5.8GHz用于图传）和协议栈（MAVLink）来区分数据优先级，保证关键指令的实时性。
*   **核心职责 (Core Responsibilities)**:
    *   通过无线数传电台接收地面控制指令
    *   向地面站发送飞行遥测数据和系统状态
    *   传输相机采集的高清图像数据流
    *   管理通讯链路的连接状态与质量
*   **关键属性 (Attributes)**:
    *   `- linkQuality: Real [%] {0..100}`
    *   `- dataRate: Real [Mbps] {0..50}`
*   **核心操作 (Operations)**:
    *   `- sendTelemetry(telemetryData: TelemetryPacket): void`
    *   `- receiveCommand(): GroundCommand`
    *   `- establishLink(groundStationID: String): ConnectionStatus`

`**PayloadController**`
*   **概述 (Overview)**: 该模块专门管理任务负载设备，如多光谱相机和云台。它作为飞行控制器与负载设备之间的适配器，将高层的任务指令（如“拍照”）翻译成设备特定的控制协议。
*   **核心职责 (Core Responsibilities)**:
    *   控制多光谱相机的拍照、录像模式
    *   稳定云台并控制其朝向
    *   管理负载设备的电源开关
    *   记录并打标采集到的数据
*   **关键属性 (Attributes)**:
    *   `- cameraTriggerInterval: Real [s] {0.5..10.0}`
    *   `- gimbalOrientation: Orientation {pitch: -90..30 [deg], roll: -30..30 [deg], yaw: 0..360 [deg]}`
*   **核心操作 (Operations)**:
    *   `- triggerCamera(shutterCommand: Command): void`
    *   `- setGimbalAngle(targetAngle: Orientation): void`

### 内部结构与交互原理 (Internal Block Diagram - IBD)

`**上下文**: FlightController`
*   **设计阐述**: 飞行控制器内部集成了多个专用处理单元，以平衡计算负载并确保实时性。主处理器运行高级导航和任务逻辑，而协处理器（如FPGA或DSP）专用于高频率的姿态控制算法。这种分离设计使得系统能够同时处理复杂的任务规划和要求苛刻的实时控制。
*   **组成部分 (Parts)**:
    *   `mainCPU: Microprocessor` - 运行任务管理、导航算法。
    *   `coprocessor: DSP` - 专用于运行PID控制算法和传感器数据预处理。
    *   `internalMemory: FlashMemory` - 存储飞行计划、配置参数和日志。
*   **连接关系 (Connectors)**:
    *   `[mainCPU.sensorDataPort] <--> [coprocessor.fusedStatePort]` - 传输融合后的状态数据。
    *   `[coprocessor.controlOutputPort] <--> [PropulsionSystem.pwmInputPort]` - 传输电机控制指令。
    *   `[mainCPU.missionPort] <--> [PayloadController.commandPort]` - 发送负载控制指令。

## 3. 活动流程

`**活动名称**: 自主任务执行流程`
*   **流程概述**: 此流程描述了无人机从接收到任务计划到完成数据采集并返航的完整自动化过程。它涵盖了任务加载、起飞、航点导航、负载操作以及任务结束处理，是系统核心价值的体现。
*   **输入/输出 (Parameters)**: `IN: mission_plan: MissionPlan`, `OUT: mission_status: MissionStatusReport`, `OUT: collected_data: DataPackage`
*   **步骤序列 (Actions)**:
    1.  **验证任务计划**: 系统检查任务计划的完整性和有效性（如航点是否可达）。
    2.  **预飞行自检**: 执行`REQ-FUN-003`和`REQ-FUN-004`相关的检查，确认动力、传感器、通讯链路正常。
    3.  **自动起飞**: 控制无人机垂直上升至预设安全高度（例如10米）。
    4.  **导航至起始航点**: 结合`REQ-FUN-001`，飞往任务区域的第一个航点。
    5.  **循环执行 [对于每一个航点]**:
        a. **飞向下一航点**: 沿直线或曲线路径飞向下一个目标位置。
        b. **到达航点判断**: 判断无人机是否进入以目标点为中心、半径为2米的范围内。
        c. **触发数据采集**: 若航点被标记为采集点，通过`PayloadController`触发相机拍照。
        d. **记录元数据**: 将时间、位置、姿态信息与采集的数据关联。
    6.  **任务完成判断**: 当所有航点遍历完毕，或收到停止指令，或触发低电量返航条件（`REQ-FUN-003`）。
    7.  **自动返航与降落**: 导航至Home点并执行自动降落程序。
    8.  **生成任务报告**: 汇总任务执行状态、采集的数据量、遇到的异常等信息。

## 4. 状态机行为

`**上下文块**: FlightController`
*   **行为模型概述**: 飞行控制器的行为模型定义了无人机从物理连接上电到任务结束下电的完整生命周期。它清晰地划分了系统在不同阶段的职责和能力，例如在`MANUAL`模式下响应遥控器指令，在`AUTO`模式下忠实执行预设任务，并在异常发生时无缝切换到安全导向的状态（如`RETURN_TO_HOME`）。

`**状态定义**:
*   `**状态名称**: INIT`
    *   **描述**: 系统上电后的初始状态，进行硬件初始化和基础自检。
    *   `entry / initializeHardware(); loadDefaultParameters()`
    *   `do / 等待通过自检或接收用户指令`
    *   `exit / 记录初始化日志`
*   `**状态名称**: STANDBY`
    *   **描述**: 系统准备就绪，等待用户指令。电机未启动。
    *   `entry / enableSensorDataStream(); establishCommLink()`
    *   `do / 持续监测系统状态和接收用户指令`
    *   `exit / 无`
*   `**状态名称**: MANUAL`
    *   **描述**: 由操作员通过遥控器直接控制无人机飞行。
    *   `entry / armMotors(); setControlSource(REMOTE)`
    *   `do / 解析遥控器指令并实时计算控制输出`
    *   `exit / disarmMotors()`
*   `**状态名称**: AUTO_MISSION`
    *   **描述**: 系统正在自动执行上传的飞行任务。
    *   `entry / loadMissionPlan(); setControlSource(INTERNAL)`
    *   `do / 执行活动流程中定义的“自主任务执行流程”`
    *   `exit / 保存任务执行日志`
*   `**状态名称**: RETURN_TO_HOME`
    *   **描述**: 紧急状态或任务结束后，自动返回起飞点。
    *   `entry / calculateReturnPath(); abortCurrentMission()`
    *   `do / 导航至Home点，并准备降落`
    *   `exit / 无`
*   `**状态名称**: LANDING`
    *   **描述**: 执行自动或受控的降落程序。
    *   `entry / initiateLandingSequence()`
    *   `do / 控制无人机平稳下降，可能使用超声波或视觉传感器辅助定高`
    *   `exit / disarmMotors()`
*   `**状态名称**: FAULT`
    *   **描述**: 系统检测到严重故障，需要立即处理。
    *   `entry / triggerAudibleVisualAlert(); logFaultCode()`
    *   `do / 根据故障类型执行相应的应急策略（如迫降、悬停）`
    *   `exit / 仅在故障排除并复位后离开`

`**转换 (Transitions)**:
*   `[INIT] --[selfTestPassed] / signalReady()--> [STANDBY]`
*   `[STANDBY] --[remoteArmCommand] / armMotors()--> [MANUAL]`
*   `[STANDBY] --[uploadMissionCommand] / loadMission()--> [AUTO_MISSION]`
*   `[MANUAL] --[autoModeSwitch] / switchToAuto()--> [AUTO_MISSION]`
*   `[AUTO_MISSION] --[lowBatteryEvent] / triggerRTH()--> [RETURN_TO_HOME]`
*   `[AUTO_MISSION] --[missionComplete] / signalCompletion()--> [RETURN_TO_HOME]`
*   `[RETURN_TO_HOME] --[reachedHomePoint] / prepareToLand()--> [LANDING]`
*   `[任何状态] --[criticalFaultDetected] / handleFault()--> [FAULT]`
*   `[LANDING] --[touchdownConfirmed] / shutdownSystems()--> [STANDBY]`

## 5. 用例场景

`**用例名称**: 执行农田测绘任务`
*   **场景简述 (Narrative)**: 农业技术员李四需要对一片500亩的玉米地进行生长状况评估。他在地面控制站软件上规划好覆盖整个田块的“弓”字形飞行路径，并设置在每个航点触发多光谱相机拍照。上传计划后，他点击“开始任务”按钮，无人机随即自动完成起飞、飞行、拍照和返航降落的全过程，李四在控制站上实时监控飞行状态和接收初步处理的数据。
*   **参与者 (Actors)**: `Primary: 农业技术员`, `Secondary: 地面控制站软件`
*   **基本流程 (Happy Path)**:
    1.  技术员登录地面控制站软件。
    2.  软件加载田块的电子地图。
    3.  技术员规划飞行路径，设置飞行高度（80米）、速度（8m/s）和相机触发模式（按距离，间隔50米）。
    4.  技术员点击“上传任务”。
    5.  无人机系统接收并验证任务计划。
    6.  技术员点击“一键起飞”。
    7.  无人机自动执行`自主任务执行流程`活动。
    8.  无人机完成任务，自动返航并降落。
    9.  地面站软件提示任务完成，并开始下载采集的多光谱图像数据。
*   **备选/异常流程**:
    *   **通讯中断**: 如果在步骤7中通讯中断超过15秒，无人机根据`REQ-FUN-004`执行应急程序（如继续完成任务或立即返航）。
    *   **天气突变**: 如果地面站接收到气象预警或无人机传感器检测到风速超标，技术员可以发送紧急指令中止任务，无人机立即进入`RETURN_TO_HOME`状态。

## 6. 参数关系

`**约束块**: FlightEnduranceEquation`
*   **物理意义与应用**: 此约束定义了无人机总重量、电池能量与悬停时间之间的关系，是系统设计中用于评估和优化续航性能的核心模型，直接影响电池选型和机体结构设计。
*   **参数 (Parameters)**:
    *   `E_battery`: 电池总能量 [Wh]
    *   `P_hover`: 悬停总功率 [W]
    *   `t_endurance`: 悬停续航时间 [min]
    *   `k_safety`: 安全系数（考虑电池不能完全放电及预留应急电力），取值 0.8
*   **约束公式 (Constraint)**:
    *   `t_endurance = (E_battery * k_safety) / P_hover * 60`

`**约束块**: LiftThrustRequirement`
*   **物理意义与应用**: 该公式描述了为保持无人机悬停，旋翼系统产生的总升力必须与无人机总重量平衡。这是选择电机、螺旋桨和计算功率消耗的基础。
*   **参数 (Parameters)**:
    *   `T_total`: 所需总推力 [N]
    *   `m_total`: 无人机总质量（含负载）[kg]
    *   `g`: 重力加速度 [9.81 m/s²]
*   **约束公式 (Constraint)**:
    *   `T_total = m_total * g`

## 7. 交互序列

`**场景名称**: 处理低电量预警事件`
*   **交互背景**: 当`PowerManagementUnit`监测到电池电量降至预设的返航阈值时，触发系统级的应急响应流程。此序列展示了从电量监测到决策，再到执行返航指令的完整组件间协作过程。
*   **涉及的生命线 (Lifelines)**: `[PowerManagementUnit]`, `[FlightController]`, `[CommunicationModule]`, `[PropulsionSystem]`
*   **消息序列 (Messages)**:
    1.  `[PowerManagementUnit] -> [FlightController] : batteryLevelUpdate(level=18%)`
    2.  `[FlightController] 内部计算，判断触发条件`
    3.  `[FlightController] -> [FlightController] : triggerLowBatteryProtocol()`
    4.  `[FlightController] -> [CommunicationModule] : sendTelemetry(alertCode=LOW_BATTERY_WARNING)`
    5.  `[CommunicationModule] -> [GroundStation] : TRANSMIT: LowBatteryAlert` （异步，不等待响应）
    6.  `[FlightController] -> [FlightController] : transitionTo(RETURN_TO_HOME)`
    7.  `[FlightController] -> [PropulsionSystem] : setMotorSpeed(..., newThrustForReturn)`