"""
ç”¨ä¾‹å›¾Agent - è´Ÿè´£åŸºäºè¾“å…¥å†…å®¹åˆ›å»ºSysMLç”¨ä¾‹å›¾
"""
import logging
import json
import os
import re
from typing import Dict, Any, List
from datetime import datetime
from pydantic import BaseModel, Field

from langchain_core.prompts import ChatPromptTemplate
from langchain_openai import ChatOpenAI
from json_repair import repair_json

from graph.workflow_state import WorkflowState, ProcessStatus
from config.settings import settings

logger = logging.getLogger(__name__)

# ==================== ç®€è¦ Prompt å ä½ ====================
# æ³¨æ„ï¼šè¯¦ç»†çš„Promptå°†åœ¨åç»­è¡¥å……
PROMPT_COT_SYSTEM = """
## è§’è‰²
ä½ æ˜¯ä¸€ä½å‡ºè‰²çš„ SysML ç”¨ä¾‹å›¾åˆ†æå¤§å¸ˆï¼Œä½ ç†Ÿæ‚‰å„ç§å¤æ‚è¯­å¢ƒï¼Œä½ å¯ä»¥ç²¾å‡†åœ°æå–å‡ºæ–‡æœ¬ä¸­çš„å‚ä¸è€…ï¼ˆActorï¼‰ã€ç”¨ä¾‹ï¼ˆUseCaseï¼‰ä»¥åŠå®ƒä»¬ä¹‹é—´å¤æ‚çš„å…³ç³»ï¼ˆå…³è”ã€åŒ…å«ã€æ‰©å±•ã€æ³›åŒ–ï¼‰ã€‚

## æ ¸å¿ƒè¦æ±‚
**ä¸ºæ¯ä¸ªè¯†åˆ«å‡ºçš„å…ƒç´ ï¼ˆå‚ä¸è€…ã€ç”¨ä¾‹ã€å…³ç³»ï¼‰éƒ½å¿…é¡»ç”Ÿæˆä¸€ä¸ª `description` å­—æ®µã€‚è¯¥å­—æ®µå¿…é¡»ä»¥ `åŸæ–‡ï¼š` å¼€å¤´ï¼Œå¼•ç”¨è¾“å…¥æ–‡æœ¬ä¸­æœ€ç›¸å…³çš„å¥å­æˆ–ç‰‡æ®µï¼Œç„¶åç”¨ `ç®€åŒ–ï¼š` æä¾›ç®€æ˜æ‰¼è¦çš„è§£é‡Šã€‚**

## è§„åˆ™

### æå–è§„åˆ™ï¼š

#### å‚ä¸è€…æ˜ å°„è§„åˆ™ï¼š
- ä¸»è¯­æˆ–åŠ¨è¯å‰çš„åè¯çŸ­è¯­æ˜ å°„ä¸ºå€™é€‰å‚ä¸è€…ã€‚
- ä»‹è¯çŸ­è¯­ä¸­çš„åè¯æ˜ å°„ä¸ºå€™é€‰å‚ä¸è€…ã€‚
- **æŠ½è±¡æ¦‚å¿µæˆ–ç³»ç»Ÿæœ¬èº«ä¸ä½œä¸ºå‚ä¸è€…**ã€‚
- å‚ä¸è€…åº”è¯¥æ˜¯ä¸ç³»ç»Ÿäº¤äº’çš„å¤–éƒ¨å®ä½“ï¼ˆäººã€ç»„ç»‡ã€å¤–éƒ¨ç³»ç»Ÿç­‰ï¼‰ã€‚

#### ç”¨ä¾‹æ˜ å°„è§„åˆ™ï¼š
- è°“è¯­æˆ–åŠ¨è¯çŸ­è¯­æ˜ å°„ä¸ºå€™é€‰ç”¨ä¾‹ã€‚
- è¿‡äºæŠ½è±¡æˆ–æ³›åŒ–çš„åŠ¨è¯çŸ­è¯­ä¸ä½œä¸ºç”¨ä¾‹ã€‚
- **ç”¨ä¾‹å‡ä»¥åŠ¨è¯å¼€å¤´**ã€‚
- **ä¸€ä¸ªç”¨ä¾‹ä¸èƒ½å‡ºç°ä¸¤ç§æˆªç„¶ä¸åŒçš„åŠ¨ä½œ**ï¼Œä¾‹å¦‚"å¼€å¯å’Œå…³é—­"åº”è¯¥æ‹†åˆ†ä¸ºä¸¤ä¸ªç”¨ä¾‹ã€‚
- ç”¨ä¾‹åº”è¯¥ä»£è¡¨ç³»ç»Ÿæä¾›çš„å…·ä½“åŠŸèƒ½æˆ–æœåŠ¡ã€‚

#### å…³ç³»æå–è§„åˆ™ï¼š

##### 1. å…³è”å…³ç³»ï¼ˆAssociationï¼‰ï¼š
- **å‚ä¸è€…ä¸ç”¨ä¾‹ä¹‹é—´åªæœ‰å…³è”å…³ç³»**ï¼Œå¹¶ä¸”æ˜¯ç”±å‚ä¸è€…æŒ‡å‘ç”¨ä¾‹ã€‚
- ä¸»è¯­å’Œè°“è¯­ä¹‹é—´å­˜åœ¨å…³è”å…³ç³»ã€‚
- æ ¼å¼ï¼š`å‚ä¸è€…A->[å…³è”]->ç”¨ä¾‹X`

##### 2. åŒ…å«å…³ç³»ï¼ˆIncludeï¼‰ï¼š
- **ç”¨ä¾‹ä¹‹é—´æœ‰åŒ…å«å…³ç³»**ã€‚
- åŒ…å«"åŒ…æ‹¬"ã€"ç”±...ç»„æˆ"ã€"éœ€è¦"ç­‰å…³é”®è¯çš„å¥å­è¡¨ç¤ºç”¨ä¾‹ä¹‹é—´å­˜åœ¨åŒ…å«å…³ç³»ã€‚
- **è¦ç‚¹**ï¼š
  - å½“å¯ä»¥ä»ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„ç”¨ä¾‹ä¸­æå–å…¬å…±è¡Œä¸ºæ—¶ï¼Œåº”è¯¥ä½¿ç”¨åŒ…å«å…³ç³»ã€‚
  - æå–å‡ºæ¥çš„å…¬å…±ç”¨ä¾‹ç§°ä¸º**æŠ½è±¡ç”¨ä¾‹**ï¼ŒåŸå§‹ç”¨ä¾‹å˜æˆ**åŸºæœ¬ç”¨ä¾‹**ã€‚
  - **ç®­å¤´ä»åŸºæœ¬ç”¨ä¾‹æŒ‡å‘æŠ½è±¡ç”¨ä¾‹**ï¼ˆè¢«åŒ…å«çš„ç”¨ä¾‹ï¼‰ã€‚
  - ä¾‹å¦‚ï¼š`å€Ÿä¹¦-[åŒ…å«]->ç™»å½•`ï¼Œ`è¿˜ä¹¦-[åŒ…å«]->ç™»å½•`
  - ä¸€ä¸ªç”¨ä¾‹çš„åŠŸèƒ½å¤ªå¤šæ—¶ï¼Œå¯ä»¥ä½¿ç”¨åŒ…å«å…³ç³»å»ºç«‹è‹¥å¹²ä¸ªæ›´å°çš„ç”¨ä¾‹ã€‚
  - ä¾‹å¦‚ï¼š`æŸ¥è¯¢ä¿¡æ¯-[åŒ…å«]->æŸ¥çœ‹ä½™é¢ä¿¡æ¯`ï¼Œ`æŸ¥è¯¢ä¿¡æ¯-[åŒ…å«]->æŸ¥çœ‹äº¤æ˜“è®°å½•`
- æ ¼å¼ï¼š`ç”¨ä¾‹A-[åŒ…å«]->ç”¨ä¾‹B`

##### 3. æ‰©å±•å…³ç³»ï¼ˆExtendï¼‰ï¼š
- **ç”¨ä¾‹ä¹‹é—´æœ‰æ‰©å±•å…³ç³»**ã€‚
- åŒ…å«"æ‰©å±•åˆ°"ã€"å¢åŠ "ã€"å¯é€‰"ç­‰å…³é”®è¯çš„å¥å­è¡¨ç¤ºç”¨ä¾‹ä¹‹é—´å­˜åœ¨æ‰©å±•å…³ç³»ã€‚
- **è¦ç‚¹**ï¼š
  - æ‰©å±•ç”¨ä¾‹åœ¨æ‰©å±•ç‚¹ä¸Šä¸ºåŸºç”¨ä¾‹å¢åŠ æ–°çš„ç»´æŠ¤å’Œå«ä¹‰ã€‚
  - æ‰©å±•ç”¨ä¾‹ä¸ºåŸºç”¨ä¾‹æ·»åŠ **å¯é€‰çš„**ã€**æ¡ä»¶æ€§çš„**è¡Œä¸ºã€‚
  - **ç®­å¤´ä»æ‰©å±•ç”¨ä¾‹æŒ‡å‘åŸºç”¨ä¾‹**ã€‚
  - ä¾‹å¦‚ï¼š`æŸ¥çœ‹ä½™é¢ä¿¡æ¯<-[æ‰©å±•]-å¯¼å‡ºExcel`ï¼Œ`æŸ¥çœ‹äº¤æ˜“è®°å½•<-[æ‰©å±•]-å¯¼å‡ºExcel`
- æ ¼å¼ï¼š`ç”¨ä¾‹B<-[æ‰©å±•]-ç”¨ä¾‹C`ï¼ˆç­‰ä»·äº `ç”¨ä¾‹C-[æ‰©å±•]->ç”¨ä¾‹B`ï¼‰

##### 4. æ³›åŒ–å…³ç³»ï¼ˆGeneralizationï¼‰ï¼š
- **å‚ä¸è€…ä¸å‚ä¸è€…ä¹‹é—´æœ‰æ³›åŒ–å…³ç³»**ï¼ˆç”¨ä¾‹ä¸ç”¨ä¾‹ä¹‹é—´ä¹Ÿå¯ä»¥æœ‰æ³›åŒ–å…³ç³»ï¼‰ã€‚
- åŒ…å«æŒ‡ç¤ºç»§æ‰¿æˆ–åˆ†ç±»çš„è¯æ±‡è¡¨ç¤ºå‚ä¸è€…æˆ–ç”¨ä¾‹ä¹‹é—´å­˜åœ¨æ³›åŒ–å…³ç³»ã€‚
- ä¾‹å¦‚ï¼š`é»„é‡‘ä¼šå‘˜-[æ³›åŒ–]->æ™®é€šç”¨æˆ·`ï¼Œ`ç®¡ç†å‘˜-[æ³›åŒ–]->ç”¨æˆ·`
- æ ¼å¼ï¼š`ç‰¹åŒ–å…ƒç´ -[æ³›åŒ–]->æ³›åŒ–å…ƒç´ `

### æ³¨æ„äº‹é¡¹ï¼š
1. **å‚ä¸è€…ä¸ç”¨ä¾‹åªæœ‰å…³è”å…³ç³»**ï¼Œå¹¶ä¸”æ˜¯ç”±å‚ä¸è€…æŒ‡å‘ç”¨ä¾‹ã€‚
2. **ç”¨ä¾‹ä¹‹é—´æœ‰åŒ…å«ã€æ‰©å±•å…³ç³»**ã€‚
3. **å‚ä¸è€…ä¸å‚ä¸è€…ä¹‹é—´æœ‰æ³›åŒ–å…³ç³»**ã€‚
4. **ç³»ç»Ÿæœ¬èº«ä¸å¯ä»¥å½“ä½œå‚ä¸è€…**ã€‚
5. åœ¨ç¬¬ä¸ƒæ­¥"ä¼˜åŒ–è¾“å‡º"ä¸­ï¼Œå¿…é¡»æ£€æŸ¥å¹¶å»é™¤å†—ä½™å…³ç³»ï¼š
   - ä¾‹å¦‚ï¼šå‚ä¸è€…Aå…³è”äº†ç”¨ä¾‹Aï¼Œç”¨ä¾‹Aæ‰©å±•äº†ç”¨ä¾‹Bï¼Œå‚ä¸è€…Aåˆå…³è”äº†ç”¨ä¾‹Bã€‚
   - è¿™ç§æƒ…å†µä¸‹ï¼Œ`å‚ä¸è€…A->ç”¨ä¾‹B` æ˜¯å†—ä½™çš„ï¼Œå› ä¸ºæ‰©å±•å…³ç³»æ„å‘³ç€ç”¨ä¾‹Bçš„è¡Œä¸ºæ˜¯ç”±ç”¨ä¾‹Açš„æ‰§è¡Œæ¡ä»¶å†³å®šçš„ã€‚
   - **åŒ…å«å…³ç³»å’Œæ‰©å±•å…³ç³»çš„ä¼ é€’æ€§ä¸ä¼šå¯¼è‡´å‚ä¸è€…å…³è”çš„å†—ä½™**ï¼Œä½†éœ€è¦æ£€æŸ¥ç›´æ¥é‡å¤çš„å…³è”ã€‚

## åˆ†ææ­¥éª¤

### æ­¥éª¤ 1ï¼šè¯†åˆ«å‚ä¸è€…ï¼ˆActorï¼‰
ä»æ–‡æœ¬ä¸­è¯†åˆ«æ‰€æœ‰ä¸ç³»ç»Ÿäº¤äº’çš„å¤–éƒ¨å®ä½“ï¼ˆäººã€ç»„ç»‡ã€å¤–éƒ¨ç³»ç»Ÿç­‰ï¼‰ã€‚
**ä¸ºæ¯ä¸ªå‚ä¸è€…ç”Ÿæˆ `description`ï¼Œæ ¼å¼ä¸º `åŸæ–‡ï¼š[æ‘˜å½•]ã€‚ç®€åŒ–ï¼š[è¯´æ˜]ã€‚`**

### æ­¥éª¤ 2ï¼šè¯†åˆ«ç”¨ä¾‹ï¼ˆUseCaseï¼‰
ä»æ–‡æœ¬ä¸­è¯†åˆ«ç³»ç»Ÿæä¾›çš„æ‰€æœ‰åŠŸèƒ½æˆ–æœåŠ¡ï¼Œç”¨ä¾‹åº”ä»¥åŠ¨è¯å¼€å¤´ã€‚
**ä¸ºæ¯ä¸ªç”¨ä¾‹ç”Ÿæˆ `description`ï¼Œæ ¼å¼ä¸º `åŸæ–‡ï¼š[æ‘˜å½•]ã€‚ç®€åŒ–ï¼š[è¯´æ˜]ã€‚`**

### æ­¥éª¤ 3ï¼šç¡®å®šç”¨ä¾‹ä¹‹é—´çš„å…³ç³»ï¼ˆåŒ…å«ã€æ‰©å±•ï¼‰
- è¯†åˆ«ç”¨ä¾‹ä¹‹é—´çš„åŒ…å«å…³ç³»ï¼ˆIncludeï¼‰ï¼šåŸºæœ¬ç”¨ä¾‹->æŠ½è±¡ç”¨ä¾‹ã€‚
- è¯†åˆ«ç”¨ä¾‹ä¹‹é—´çš„æ‰©å±•å…³ç³»ï¼ˆExtendï¼‰ï¼šæ‰©å±•ç”¨ä¾‹->åŸºç”¨ä¾‹ã€‚
**ä¸ºæ¯ä¸ªå…³ç³»ç”Ÿæˆ `description`ï¼Œè¯´æ˜å…³ç³»çš„å«ä¹‰å’Œä¾æ®ã€‚**

### æ­¥éª¤ 4ï¼šç¡®å®šå‚ä¸è€…ä¸ç”¨ä¾‹çš„å…³ç³»ï¼ˆå…³è”ï¼‰
è¯†åˆ«å‚ä¸è€…ä¸ç”¨ä¾‹ä¹‹é—´çš„å…³è”å…³ç³»ï¼Œç®­å¤´ä»å‚ä¸è€…æŒ‡å‘ç”¨ä¾‹ã€‚
**ä¸ºæ¯ä¸ªå…³è”ç”Ÿæˆ `description`ã€‚**

### æ­¥éª¤ 5ï¼šç¡®å®šå‚ä¸è€…ä¹‹é—´çš„å…³ç³»ï¼ˆæ³›åŒ–ï¼‰
è¯†åˆ«å‚ä¸è€…ä¹‹é—´çš„æ³›åŒ–å…³ç³»ï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œç®­å¤´ä»ç‰¹åŒ–å…ƒç´ æŒ‡å‘æ³›åŒ–å…ƒç´ ã€‚
**ä¸ºæ¯ä¸ªæ³›åŒ–å…³ç³»ç”Ÿæˆ `description`ã€‚**

### æ­¥éª¤ 6ï¼šç»¼åˆè¾“å‡º
æ±‡æ€»æ‰€æœ‰è¯†åˆ«å‡ºçš„å‚ä¸è€…ã€ç”¨ä¾‹å’Œå…³ç³»ï¼Œå½¢æˆåˆæ­¥çš„åˆ—è¡¨ã€‚

### æ­¥éª¤ 7ï¼šä¼˜åŒ–è¾“å‡º
æ£€æŸ¥å¹¶å»é™¤å†—ä½™å…³ç³»ï¼š
- å¦‚æœå‚ä¸è€…Aå…³è”ç”¨ä¾‹Aï¼Œç”¨ä¾‹Aæ‰©å±•/åŒ…å«ç”¨ä¾‹Bï¼Œä¸”å‚ä¸è€…Aä¹Ÿç›´æ¥å…³è”ç”¨ä¾‹Bï¼Œåˆ™å‚ä¸è€…A->ç”¨ä¾‹Bæ˜¯å†—ä½™çš„ã€‚
- æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤çš„å…³ç³»å®šä¹‰ã€‚
- ç¡®ä¿æ‰€æœ‰å…³ç³»æ–¹å‘æ­£ç¡®ï¼ˆå…³è”ï¼šå‚ä¸è€…->ç”¨ä¾‹ï¼ŒåŒ…å«ï¼šåŸºç”¨ä¾‹->æŠ½è±¡ç”¨ä¾‹ï¼Œæ‰©å±•ï¼šæ‰©å±•ç”¨ä¾‹->åŸºç”¨ä¾‹ï¼‰ã€‚

## è¾“å‡ºæ ·ä¾‹

### è¾“å…¥æ ·ä¾‹ï¼š
"åœ¨ä¸€ä¸ªç®€å•çš„è½¦æœºç©ºè°ƒæ¡ˆä¾‹ä¸­ï¼Œå¸æœºå¯ä»¥é€šè¿‡è½¦è½½ç³»ç»Ÿå¼€å¯ç©ºè°ƒï¼Œå¹¶è®¾ç½®ç›¸å…³å‚æ•°ï¼Œå¦‚æ¸©åº¦ã€é£å‘å’Œæ¹¿åº¦ã€‚å¼€å¯ç©ºè°ƒçš„æ“ä½œå¿…é¡»åŒ…å«æ‰“ç«å¯åŠ¨è¿™ä¸€å‰ç½®æ¡ä»¶ã€‚ä¸æ­¤åŒæ—¶ï¼Œç»´ä¿®äººå‘˜è´Ÿè´£å¯¹ç©ºè°ƒè¿›è¡Œæ£€æŸ¥å’Œä¿®ç†ï¼Œç¡®ä¿å…¶æ­£å¸¸è¿è¡Œï¼Œç»´ä¿®å®Œæ¯•åï¼Œç»´ä¿®äººå‘˜å¯ä»¥æ‰“å°ç»´ä¿®æŠ¥å‘Šã€‚"

### æ€è€ƒè¿‡ç¨‹ï¼ˆCoTæ¨ç†ï¼‰ï¼š

#### æ­¥éª¤ 1ï¼šè¯†åˆ«å‚ä¸è€…ï¼ˆActorï¼‰
- **å¸æœº**
  - Description: `åŸæ–‡ï¼šå¸æœºå¯ä»¥é€šè¿‡è½¦è½½ç³»ç»Ÿå¼€å¯ç©ºè°ƒã€‚ç®€åŒ–ï¼šè½¦æœºç©ºè°ƒç³»ç»Ÿçš„ä¸»è¦ä½¿ç”¨è€…ï¼Œè´Ÿè´£æ“ä½œç©ºè°ƒåŠŸèƒ½ã€‚`
- **ç»´ä¿®äººå‘˜**
  - Description: `åŸæ–‡ï¼šç»´ä¿®äººå‘˜è´Ÿè´£å¯¹ç©ºè°ƒè¿›è¡Œæ£€æŸ¥å’Œä¿®ç†ã€‚ç®€åŒ–ï¼šè´Ÿè´£ç»´æŠ¤å’Œä¿®ç†è½¦æœºç©ºè°ƒç³»ç»Ÿçš„æŠ€æœ¯äººå‘˜ã€‚`

#### æ­¥éª¤ 2ï¼šè¯†åˆ«ç”¨ä¾‹ï¼ˆUseCaseï¼‰
- **å¼€å¯ç©ºè°ƒ**
  - Description: `åŸæ–‡ï¼šå¸æœºå¯ä»¥é€šè¿‡è½¦è½½ç³»ç»Ÿå¼€å¯ç©ºè°ƒã€‚ç®€åŒ–ï¼šå¯åŠ¨è½¦æœºç©ºè°ƒç³»ç»Ÿçš„åŸºæœ¬åŠŸèƒ½ã€‚`
- **è®¾ç½®ç›¸å…³å‚æ•°**
  - Description: `åŸæ–‡ï¼šå¹¶è®¾ç½®ç›¸å…³å‚æ•°ï¼Œå¦‚æ¸©åº¦ã€é£å‘å’Œæ¹¿åº¦ã€‚ç®€åŒ–ï¼šé…ç½®ç©ºè°ƒçš„è¿è¡Œå‚æ•°ï¼ŒåŒ…æ‹¬æ¸©åº¦ã€é£å‘å’Œæ¹¿åº¦ã€‚`
- **è®¾ç½®æ¸©åº¦**
  - Description: `åŸæ–‡ï¼šå¦‚æ¸©åº¦ã€é£å‘å’Œæ¹¿åº¦ã€‚ç®€åŒ–ï¼šè°ƒæ•´ç©ºè°ƒçš„ç›®æ ‡æ¸©åº¦ã€‚`
- **è®¾ç½®é£å‘**
  - Description: `åŸæ–‡ï¼šå¦‚æ¸©åº¦ã€é£å‘å’Œæ¹¿åº¦ã€‚ç®€åŒ–ï¼šè°ƒæ•´ç©ºè°ƒå‡ºé£å£çš„æ–¹å‘ã€‚`
- **è®¾ç½®æ¹¿åº¦**
  - Description: `åŸæ–‡ï¼šå¦‚æ¸©åº¦ã€é£å‘å’Œæ¹¿åº¦ã€‚ç®€åŒ–ï¼šè°ƒæ•´ç©ºè°ƒçš„æ¹¿åº¦æ§åˆ¶å‚æ•°ã€‚`
- **æ‰“ç«å¯åŠ¨**
  - Description: `åŸæ–‡ï¼šå¼€å¯ç©ºè°ƒçš„æ“ä½œå¿…é¡»åŒ…å«æ‰“ç«å¯åŠ¨è¿™ä¸€å‰ç½®æ¡ä»¶ã€‚ç®€åŒ–ï¼šå¯åŠ¨è½¦è¾†å¼•æ“ï¼Œæ˜¯å¼€å¯ç©ºè°ƒçš„å¿…è¦å‰æã€‚`
- **æ£€æŸ¥ç©ºè°ƒ**
  - Description: `åŸæ–‡ï¼šç»´ä¿®äººå‘˜è´Ÿè´£å¯¹ç©ºè°ƒè¿›è¡Œæ£€æŸ¥ã€‚ç®€åŒ–ï¼šå¯¹ç©ºè°ƒç³»ç»Ÿè¿›è¡Œæ•…éšœè¯Šæ–­å’Œæ€§èƒ½æ£€æŸ¥ã€‚`
- **ä¿®ç†ç©ºè°ƒ**
  - Description: `åŸæ–‡ï¼šç»´ä¿®äººå‘˜è´Ÿè´£å¯¹ç©ºè°ƒè¿›è¡Œæ£€æŸ¥å’Œä¿®ç†ã€‚ç®€åŒ–ï¼šå¯¹æ•…éšœçš„ç©ºè°ƒç³»ç»Ÿè¿›è¡Œç»´ä¿®å’Œæ›´æ¢éƒ¨ä»¶ã€‚`
- **æ‰“å°ç»´ä¿®æŠ¥å‘Š**
  - Description: `åŸæ–‡ï¼šç»´ä¿®å®Œæ¯•åï¼Œç»´ä¿®äººå‘˜å¯ä»¥æ‰“å°ç»´ä¿®æŠ¥å‘Šã€‚ç®€åŒ–ï¼šç”Ÿæˆå¹¶æ‰“å°ç»´ä¿®å·¥ä½œçš„è¯¦ç»†æŠ¥å‘Šã€‚`

#### æ­¥éª¤ 3ï¼šç¡®å®šç”¨ä¾‹ä¹‹é—´çš„å…³ç³»ï¼ˆåŒ…å«ã€æ‰©å±•ï¼‰
- **åŒ…å«å…³ç³»**ï¼š
  - `å¼€å¯ç©ºè°ƒ-[åŒ…å«]->æ‰“ç«å¯åŠ¨`
    - Description: `åŸæ–‡ï¼šå¼€å¯ç©ºè°ƒçš„æ“ä½œå¿…é¡»åŒ…å«æ‰“ç«å¯åŠ¨è¿™ä¸€å‰ç½®æ¡ä»¶ã€‚ç®€åŒ–ï¼šå¼€å¯ç©ºè°ƒä¹‹å‰å¿…é¡»å…ˆå®Œæˆæ‰“ç«å¯åŠ¨ï¼Œè¿™æ˜¯ä¸€ä¸ªå¿…è¦çš„å…¬å…±å‰ç½®æ­¥éª¤ã€‚`
  - `è®¾ç½®ç›¸å…³å‚æ•°-[åŒ…å«]->è®¾ç½®æ¸©åº¦`
    - Description: `åŸæ–‡ï¼šè®¾ç½®ç›¸å…³å‚æ•°ï¼Œå¦‚æ¸©åº¦ã€‚ç®€åŒ–ï¼šè®¾ç½®ç›¸å…³å‚æ•°åŒ…å«è®¾ç½®æ¸©åº¦è¿™ä¸€å…·ä½“æ“ä½œã€‚`
  - `è®¾ç½®ç›¸å…³å‚æ•°-[åŒ…å«]->è®¾ç½®é£å‘`
    - Description: `åŸæ–‡ï¼šè®¾ç½®ç›¸å…³å‚æ•°ï¼Œå¦‚é£å‘ã€‚ç®€åŒ–ï¼šè®¾ç½®ç›¸å…³å‚æ•°åŒ…å«è®¾ç½®é£å‘è¿™ä¸€å…·ä½“æ“ä½œã€‚`
  - `è®¾ç½®ç›¸å…³å‚æ•°-[åŒ…å«]->è®¾ç½®æ¹¿åº¦`
    - Description: `åŸæ–‡ï¼šè®¾ç½®ç›¸å…³å‚æ•°ï¼Œå¦‚æ¹¿åº¦ã€‚ç®€åŒ–ï¼šè®¾ç½®ç›¸å…³å‚æ•°åŒ…å«è®¾ç½®æ¹¿åº¦è¿™ä¸€å…·ä½“æ“ä½œã€‚`

- **æ‰©å±•å…³ç³»**ï¼š
  - `ä¿®ç†ç©ºè°ƒ<-[æ‰©å±•]-æ‰“å°ç»´ä¿®æŠ¥å‘Š`ï¼ˆç­‰ä»·äº `æ‰“å°ç»´ä¿®æŠ¥å‘Š-[æ‰©å±•]->ä¿®ç†ç©ºè°ƒ`ï¼‰
    - Description: `åŸæ–‡ï¼šç»´ä¿®å®Œæ¯•åï¼Œç»´ä¿®äººå‘˜å¯ä»¥æ‰“å°ç»´ä¿®æŠ¥å‘Šã€‚ç®€åŒ–ï¼šæ‰“å°ç»´ä¿®æŠ¥å‘Šæ˜¯ä¿®ç†ç©ºè°ƒå®Œæˆåçš„å¯é€‰æ“ä½œï¼Œä¸ºä¿®ç†ç©ºè°ƒç”¨ä¾‹å¢åŠ äº†æ–‡æ¡£è®°å½•åŠŸèƒ½ã€‚`

#### æ­¥éª¤ 4ï¼šç¡®å®šå‚ä¸è€…ä¸ç”¨ä¾‹çš„å…³ç³»ï¼ˆå…³è”ï¼‰
- `å¸æœº->[å…³è”]->å¼€å¯ç©ºè°ƒ`
  - Description: `åŸæ–‡ï¼šå¸æœºå¯ä»¥é€šè¿‡è½¦è½½ç³»ç»Ÿå¼€å¯ç©ºè°ƒã€‚ç®€åŒ–ï¼šå¸æœºä½¿ç”¨å¼€å¯ç©ºè°ƒåŠŸèƒ½ã€‚`
- `å¸æœº->[å…³è”]->æ‰“ç«å¯åŠ¨`
  - Description: `åŸæ–‡ï¼šå¼€å¯ç©ºè°ƒçš„æ“ä½œå¿…é¡»åŒ…å«æ‰“ç«å¯åŠ¨ã€‚ç®€åŒ–ï¼šå¸æœºæ‰§è¡Œæ‰“ç«å¯åŠ¨æ“ä½œï¼ˆä½œä¸ºå¼€å¯ç©ºè°ƒçš„å‰æï¼‰ã€‚`
- `å¸æœº->[å…³è”]->è®¾ç½®ç›¸å…³å‚æ•°`
  - Description: `åŸæ–‡ï¼šå¸æœºå¯ä»¥è®¾ç½®ç›¸å…³å‚æ•°ã€‚ç®€åŒ–ï¼šå¸æœºä½¿ç”¨è®¾ç½®ç›¸å…³å‚æ•°åŠŸèƒ½ã€‚`
- `ç»´ä¿®äººå‘˜->[å…³è”]->æ£€æŸ¥ç©ºè°ƒ`
  - Description: `åŸæ–‡ï¼šç»´ä¿®äººå‘˜è´Ÿè´£å¯¹ç©ºè°ƒè¿›è¡Œæ£€æŸ¥ã€‚ç®€åŒ–ï¼šç»´ä¿®äººå‘˜ä½¿ç”¨æ£€æŸ¥ç©ºè°ƒåŠŸèƒ½ã€‚`
- `ç»´ä¿®äººå‘˜->[å…³è”]->ä¿®ç†ç©ºè°ƒ`
  - Description: `åŸæ–‡ï¼šç»´ä¿®äººå‘˜è´Ÿè´£å¯¹ç©ºè°ƒè¿›è¡Œä¿®ç†ã€‚ç®€åŒ–ï¼šç»´ä¿®äººå‘˜ä½¿ç”¨ä¿®ç†ç©ºè°ƒåŠŸèƒ½ã€‚`

#### æ­¥éª¤ 5ï¼šç¡®å®šå‚ä¸è€…ä¹‹é—´çš„å…³ç³»ï¼ˆæ³›åŒ–ï¼‰
- æœ¬æ¡ˆä¾‹ä¸­æ²¡æœ‰å‚ä¸è€…ä¹‹é—´çš„æ³›åŒ–å…³ç³»ã€‚

#### æ­¥éª¤ 6ï¼šç»¼åˆè¾“å‡º
- **å‚ä¸è€…**ï¼šå¸æœºã€ç»´ä¿®äººå‘˜
- **ç”¨ä¾‹**ï¼šå¼€å¯ç©ºè°ƒã€è®¾ç½®ç›¸å…³å‚æ•°ã€è®¾ç½®æ¸©åº¦ã€è®¾ç½®é£å‘ã€è®¾ç½®æ¹¿åº¦ã€æ‰“ç«å¯åŠ¨ã€æ£€æŸ¥ç©ºè°ƒã€ä¿®ç†ç©ºè°ƒã€æ‰“å°ç»´ä¿®æŠ¥å‘Š
- **å…³ç³»**ï¼š
  - å…³è”ï¼šå¸æœº->[å…³è”]->å¼€å¯ç©ºè°ƒã€å¸æœº->[å…³è”]->æ‰“ç«å¯åŠ¨ã€å¸æœº->[å…³è”]->è®¾ç½®ç›¸å…³å‚æ•°ã€ç»´ä¿®äººå‘˜->[å…³è”]->æ£€æŸ¥ç©ºè°ƒã€ç»´ä¿®äººå‘˜->[å…³è”]->ä¿®ç†ç©ºè°ƒ
  - åŒ…å«ï¼šå¼€å¯ç©ºè°ƒ-[åŒ…å«]->æ‰“ç«å¯åŠ¨ã€è®¾ç½®ç›¸å…³å‚æ•°-[åŒ…å«]->è®¾ç½®æ¸©åº¦ã€è®¾ç½®ç›¸å…³å‚æ•°-[åŒ…å«]->è®¾ç½®é£å‘ã€è®¾ç½®ç›¸å…³å‚æ•°-[åŒ…å«]->è®¾ç½®æ¹¿åº¦
  - æ‰©å±•ï¼šä¿®ç†ç©ºè°ƒ<-[æ‰©å±•]-æ‰“å°ç»´ä¿®æŠ¥å‘Š

#### æ­¥éª¤ 7ï¼šä¼˜åŒ–è¾“å‡º
æ£€æŸ¥å†—ä½™å…³ç³»ï¼š
- `å¸æœº->[å…³è”]->æ‰“ç«å¯åŠ¨` çœ‹ä¼¼å†—ä½™ï¼ˆå› ä¸ºå¼€å¯ç©ºè°ƒå·²ç»åŒ…å«æ‰“ç«å¯åŠ¨ï¼‰ï¼Œä½†æ ¹æ®ä¸šåŠ¡é€»è¾‘ï¼Œå¸æœºå¯èƒ½å•ç‹¬æ‰§è¡Œæ‰“ç«å¯åŠ¨è€Œä¸ç«‹å³å¼€å¯ç©ºè°ƒï¼Œæ‰€ä»¥è¿™ä¸ªå…³è”åº”è¯¥ä¿ç•™ã€‚
- å¦‚æœä¸šåŠ¡ä¸Šç¡®è®¤æ‰“ç«å¯åŠ¨åªåœ¨å¼€å¯ç©ºè°ƒæ—¶ä½¿ç”¨ï¼Œåˆ™å¯ä»¥åˆ é™¤ `å¸æœº->[å…³è”]->æ‰“ç«å¯åŠ¨`ã€‚
- æœ¬æ¡ˆä¾‹ä¸­ï¼Œå‡è®¾å¸æœºå¯ä»¥ç‹¬ç«‹æ‰§è¡Œæ‰“ç«å¯åŠ¨ï¼Œå› æ­¤ä¿ç•™è¯¥å…³è”ã€‚

**æœ€ç»ˆä¼˜åŒ–è¾“å‡º**ï¼š
- **å‚ä¸è€…**ï¼šå¸æœºã€ç»´ä¿®äººå‘˜
- **ç”¨ä¾‹**ï¼šå¼€å¯ç©ºè°ƒã€è®¾ç½®ç›¸å…³å‚æ•°ã€è®¾ç½®æ¸©åº¦ã€è®¾ç½®é£å‘ã€è®¾ç½®æ¹¿åº¦ã€æ‰“ç«å¯åŠ¨ã€æ£€æŸ¥ç©ºè°ƒã€ä¿®ç†ç©ºè°ƒã€æ‰“å°ç»´ä¿®æŠ¥å‘Š
- **å…³ç³»**ï¼š
  - å…³è”ï¼šå¸æœº->[å…³è”]->å¼€å¯ç©ºè°ƒã€å¸æœº->[å…³è”]->æ‰“ç«å¯åŠ¨ã€å¸æœº->[å…³è”]->è®¾ç½®ç›¸å…³å‚æ•°ã€ç»´ä¿®äººå‘˜->[å…³è”]->æ£€æŸ¥ç©ºè°ƒã€ç»´ä¿®äººå‘˜->[å…³è”]->ä¿®ç†ç©ºè°ƒ
  - åŒ…å«ï¼šå¼€å¯ç©ºè°ƒ-[åŒ…å«]->æ‰“ç«å¯åŠ¨ã€è®¾ç½®ç›¸å…³å‚æ•°-[åŒ…å«]->è®¾ç½®æ¸©åº¦ã€è®¾ç½®ç›¸å…³å‚æ•°-[åŒ…å«]->è®¾ç½®é£å‘ã€è®¾ç½®ç›¸å…³å‚æ•°-[åŒ…å«]->è®¾ç½®æ¹¿åº¦
  - æ‰©å±•ï¼šæ‰“å°ç»´ä¿®æŠ¥å‘Š-[æ‰©å±•]->ä¿®ç†ç©ºè°ƒ

---

## å…·ä½“ä»»åŠ¡
è¯·æŒ‰ç…§ä¸Šè¿°ä¸ƒä¸ªæ­¥éª¤å¯¹è¾“å…¥æ–‡æœ¬è¿›è¡Œåˆ†æï¼Œä¸ºæ¯ä¸ªè¯†åˆ«å‡ºçš„å…ƒç´ å’Œå…³ç³»ç”ŸæˆåŒ…å«åŸæ–‡å¼•ç”¨çš„ descriptionã€‚
"""

PROMPT_JSON_SYSTEM = """
æ ¹æ®ä»¥ä¸Šè¯¦ç»†çš„æ¨ç†å’Œ"æœ€ç»ˆä¼˜åŒ–è¾“å‡º"ï¼Œè¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ JSON æ ¼å¼ç”Ÿæˆ SysML ç”¨ä¾‹å›¾çš„å®Œæ•´æè¿°ã€‚

## æ ¸å¿ƒè¦æ±‚
1. **æ‰€æœ‰ `id` å­—æ®µéƒ½æ˜¯å…¨å±€å”¯ä¸€çš„å­—ç¬¦ä¸²ã€‚**
2. **æ¯ä¸ªå…ƒç´ éƒ½å¿…é¡»åŒ…å« `description` å­—æ®µ**ï¼Œå†…å®¹åº”ä¸æ¨ç†æ­¥éª¤ä¸­ç”Ÿæˆçš„æè¿°ä¿æŒä¸€è‡´ã€‚
3. **`parentId` æ­£ç¡®åæ˜ äº†å…ƒç´ çš„åŒ…å«å…³ç³»**ï¼ˆé€šå¸¸æ‰€æœ‰å…ƒç´ éƒ½å±äºåŒä¸€ä¸ªåŒ…ï¼ŒåŒ…å±äºæ¨¡å‹ï¼‰ã€‚
4. å¯¹äº `Actor` å’Œ `UseCase` å…ƒç´ ï¼š
   - å¿…é¡»åŒ…å« `id`, `type`, `name`, `parentId`, `description`ã€‚
5. å¯¹äºå…³ç³»å…ƒç´ ï¼ˆ`Association`, `Include`, `Extend`, `Generalization`ï¼‰ï¼š
   - å¿…é¡»åŒ…å« `id`, `type`, `sourceId`, `targetId`, `parentId`, `description`ã€‚
   - `sourceId` å’Œ `targetId` å¿…é¡»æ­£ç¡®å¼•ç”¨å·²å®šä¹‰çš„å…ƒç´  IDã€‚
   - **å…³è”å…³ç³»ï¼ˆAssociationï¼‰**ï¼š`sourceId` æ˜¯å‚ä¸è€…ï¼Œ`targetId` æ˜¯ç”¨ä¾‹ã€‚
   - **åŒ…å«å…³ç³»ï¼ˆIncludeï¼‰**ï¼š`sourceId` æ˜¯åŸºæœ¬ç”¨ä¾‹ï¼Œ`targetId` æ˜¯æŠ½è±¡ç”¨ä¾‹ï¼ˆè¢«åŒ…å«çš„ç”¨ä¾‹ï¼‰ã€‚
   - **æ‰©å±•å…³ç³»ï¼ˆExtendï¼‰**ï¼š`sourceId` æ˜¯æ‰©å±•ç”¨ä¾‹ï¼Œ`targetId` æ˜¯åŸºç”¨ä¾‹ã€‚
   - **æ³›åŒ–å…³ç³»ï¼ˆGeneralizationï¼‰**ï¼š`sourceId` æ˜¯ç‰¹åŒ–å…ƒç´ ï¼Œ`targetId` æ˜¯æ³›åŒ–å…ƒç´ ã€‚
6. **JSON æ ¹å¯¹è±¡åªåŒ…å« `model` å’Œ `elements` ä¸¤ä¸ªé”®ã€‚**

## ç¤ºä¾‹ JSON ç»“æ„

```json
{
  "model": [
    {
      "id": "model-car-ac-uc-uuid",
      "name": "è½¦æœºç©ºè°ƒç”¨ä¾‹æ¨¡å‹",
      "description": "åŸæ–‡ï¼šåœ¨ä¸€ä¸ªç®€å•çš„è½¦æœºç©ºè°ƒæ¡ˆä¾‹ä¸­ã€‚ç®€åŒ–ï¼šæè¿°è½¦æœºç©ºè°ƒç³»ç»Ÿçš„æ‰€æœ‰ç”¨ä¾‹å’Œå‚ä¸è€…äº¤äº’ã€‚"
    }
  ],
  "elements": [
    {
      "id": "pkg-car-ac-main-uuid",
      "type": "Package",
      "name": "ä¸»è¦ç”¨ä¾‹",
      "parentId": "model-car-ac-uc-uuid",
      "description": "åŸæ–‡ï¼šè½¦æœºç©ºè°ƒæ¡ˆä¾‹ã€‚ç®€åŒ–ï¼šåŒ…å«è½¦æœºç©ºè°ƒç³»ç»Ÿçš„æ‰€æœ‰æ ¸å¿ƒç”¨ä¾‹å’Œå‚ä¸è€…ã€‚"
    },
    {
      "id": "actor-driver-uuid",
      "type": "Actor",
      "name": "å¸æœº",
      "parentId": "pkg-car-ac-main-uuid",
      "description": "åŸæ–‡ï¼šå¸æœºå¯ä»¥é€šè¿‡è½¦è½½ç³»ç»Ÿå¼€å¯ç©ºè°ƒã€‚ç®€åŒ–ï¼šè½¦æœºç©ºè°ƒç³»ç»Ÿçš„ä¸»è¦ä½¿ç”¨è€…ï¼Œè´Ÿè´£æ“ä½œç©ºè°ƒåŠŸèƒ½ã€‚"
    },
    {
      "id": "actor-technician-uuid",
      "type": "Actor",
      "name": "ç»´ä¿®äººå‘˜",
      "parentId": "pkg-car-ac-main-uuid",
      "description": "åŸæ–‡ï¼šç»´ä¿®äººå‘˜è´Ÿè´£å¯¹ç©ºè°ƒè¿›è¡Œæ£€æŸ¥å’Œä¿®ç†ã€‚ç®€åŒ–ï¼šè´Ÿè´£ç»´æŠ¤å’Œä¿®ç†è½¦æœºç©ºè°ƒç³»ç»Ÿçš„æŠ€æœ¯äººå‘˜ã€‚"
    },
    {
      "id": "uc-turn-on-ac-uuid",
      "type": "UseCase",
      "name": "å¼€å¯ç©ºè°ƒ",
      "parentId": "pkg-car-ac-main-uuid",
      "description": "åŸæ–‡ï¼šå¸æœºå¯ä»¥é€šè¿‡è½¦è½½ç³»ç»Ÿå¼€å¯ç©ºè°ƒã€‚ç®€åŒ–ï¼šå¯åŠ¨è½¦æœºç©ºè°ƒç³»ç»Ÿçš„åŸºæœ¬åŠŸèƒ½ã€‚"
    },
    {
      "id": "uc-set-params-uuid",
      "type": "UseCase",
      "name": "è®¾ç½®ç›¸å…³å‚æ•°",
      "parentId": "pkg-car-ac-main-uuid",
      "description": "åŸæ–‡ï¼šå¹¶è®¾ç½®ç›¸å…³å‚æ•°ï¼Œå¦‚æ¸©åº¦ã€é£å‘å’Œæ¹¿åº¦ã€‚ç®€åŒ–ï¼šé…ç½®ç©ºè°ƒçš„è¿è¡Œå‚æ•°ï¼ŒåŒ…æ‹¬æ¸©åº¦ã€é£å‘å’Œæ¹¿åº¦ã€‚"
    },
    {
      "id": "uc-set-temp-uuid",
      "type": "UseCase",
      "name": "è®¾ç½®æ¸©åº¦",
      "parentId": "pkg-car-ac-main-uuid",
      "description": "åŸæ–‡ï¼šå¦‚æ¸©åº¦ã€é£å‘å’Œæ¹¿åº¦ã€‚ç®€åŒ–ï¼šè°ƒæ•´ç©ºè°ƒçš„ç›®æ ‡æ¸©åº¦ã€‚"
    },
    {
      "id": "uc-set-direction-uuid",
      "type": "UseCase",
      "name": "è®¾ç½®é£å‘",
      "parentId": "pkg-car-ac-main-uuid",
      "description": "åŸæ–‡ï¼šå¦‚æ¸©åº¦ã€é£å‘å’Œæ¹¿åº¦ã€‚ç®€åŒ–ï¼šè°ƒæ•´ç©ºè°ƒå‡ºé£å£çš„æ–¹å‘ã€‚"
    },
    {
      "id": "uc-set-humidity-uuid",
      "type": "UseCase",
      "name": "è®¾ç½®æ¹¿åº¦",
      "parentId": "pkg-car-ac-main-uuid",
      "description": "åŸæ–‡ï¼šå¦‚æ¸©åº¦ã€é£å‘å’Œæ¹¿åº¦ã€‚ç®€åŒ–ï¼šè°ƒæ•´ç©ºè°ƒçš„æ¹¿åº¦æ§åˆ¶å‚æ•°ã€‚"
    },
    {
      "id": "uc-ignition-uuid",
      "type": "UseCase",
      "name": "æ‰“ç«å¯åŠ¨",
      "parentId": "pkg-car-ac-main-uuid",
      "description": "åŸæ–‡ï¼šå¼€å¯ç©ºè°ƒçš„æ“ä½œå¿…é¡»åŒ…å«æ‰“ç«å¯åŠ¨è¿™ä¸€å‰ç½®æ¡ä»¶ã€‚ç®€åŒ–ï¼šå¯åŠ¨è½¦è¾†å¼•æ“ï¼Œæ˜¯å¼€å¯ç©ºè°ƒçš„å¿…è¦å‰æã€‚"
    },
    {
      "id": "uc-check-ac-uuid",
      "type": "UseCase",
      "name": "æ£€æŸ¥ç©ºè°ƒ",
      "parentId": "pkg-car-ac-main-uuid",
      "description": "åŸæ–‡ï¼šç»´ä¿®äººå‘˜è´Ÿè´£å¯¹ç©ºè°ƒè¿›è¡Œæ£€æŸ¥ã€‚ç®€åŒ–ï¼šå¯¹ç©ºè°ƒç³»ç»Ÿè¿›è¡Œæ•…éšœè¯Šæ–­å’Œæ€§èƒ½æ£€æŸ¥ã€‚"
    },
    {
      "id": "uc-repair-ac-uuid",
      "type": "UseCase",
      "name": "ä¿®ç†ç©ºè°ƒ",
      "parentId": "pkg-car-ac-main-uuid",
      "description": "åŸæ–‡ï¼šç»´ä¿®äººå‘˜è´Ÿè´£å¯¹ç©ºè°ƒè¿›è¡Œæ£€æŸ¥å’Œä¿®ç†ã€‚ç®€åŒ–ï¼šå¯¹æ•…éšœçš„ç©ºè°ƒç³»ç»Ÿè¿›è¡Œç»´ä¿®å’Œæ›´æ¢éƒ¨ä»¶ã€‚"
    },
    {
      "id": "uc-print-report-uuid",
      "type": "UseCase",
      "name": "æ‰“å°ç»´ä¿®æŠ¥å‘Š",
      "parentId": "pkg-car-ac-main-uuid",
      "description": "åŸæ–‡ï¼šç»´ä¿®å®Œæ¯•åï¼Œç»´ä¿®äººå‘˜å¯ä»¥æ‰“å°ç»´ä¿®æŠ¥å‘Šã€‚ç®€åŒ–ï¼šç”Ÿæˆå¹¶æ‰“å°ç»´ä¿®å·¥ä½œçš„è¯¦ç»†æŠ¥å‘Šã€‚"
    },
    {
      "id": "assoc-driver-turn-on-uuid",
      "type": "Association",
      "sourceId": "actor-driver-uuid",
      "targetId": "uc-turn-on-ac-uuid",
      "parentId": "pkg-car-ac-main-uuid",
      "description": "åŸæ–‡ï¼šå¸æœºå¯ä»¥é€šè¿‡è½¦è½½ç³»ç»Ÿå¼€å¯ç©ºè°ƒã€‚ç®€åŒ–ï¼šå¸æœºä½¿ç”¨å¼€å¯ç©ºè°ƒåŠŸèƒ½ã€‚"
    },
    {
      "id": "assoc-driver-ignition-uuid",
      "type": "Association",
      "sourceId": "actor-driver-uuid",
      "targetId": "uc-ignition-uuid",
      "parentId": "pkg-car-ac-main-uuid",
      "description": "åŸæ–‡ï¼šå¼€å¯ç©ºè°ƒçš„æ“ä½œå¿…é¡»åŒ…å«æ‰“ç«å¯åŠ¨ã€‚ç®€åŒ–ï¼šå¸æœºæ‰§è¡Œæ‰“ç«å¯åŠ¨æ“ä½œï¼ˆä½œä¸ºå¼€å¯ç©ºè°ƒçš„å‰æï¼‰ã€‚"
    },
    {
      "id": "assoc-driver-set-params-uuid",
      "type": "Association",
      "sourceId": "actor-driver-uuid",
      "targetId": "uc-set-params-uuid",
      "parentId": "pkg-car-ac-main-uuid",
      "description": "åŸæ–‡ï¼šå¸æœºå¯ä»¥è®¾ç½®ç›¸å…³å‚æ•°ã€‚ç®€åŒ–ï¼šå¸æœºä½¿ç”¨è®¾ç½®ç›¸å…³å‚æ•°åŠŸèƒ½ã€‚"
    },
    {
      "id": "assoc-tech-check-uuid",
      "type": "Association",
      "sourceId": "actor-technician-uuid",
      "targetId": "uc-check-ac-uuid",
      "parentId": "pkg-car-ac-main-uuid",
      "description": "åŸæ–‡ï¼šç»´ä¿®äººå‘˜è´Ÿè´£å¯¹ç©ºè°ƒè¿›è¡Œæ£€æŸ¥ã€‚ç®€åŒ–ï¼šç»´ä¿®äººå‘˜ä½¿ç”¨æ£€æŸ¥ç©ºè°ƒåŠŸèƒ½ã€‚"
    },
    {
      "id": "assoc-tech-repair-uuid",
      "type": "Association",
      "sourceId": "actor-technician-uuid",
      "targetId": "uc-repair-ac-uuid",
      "parentId": "pkg-car-ac-main-uuid",
      "description": "åŸæ–‡ï¼šç»´ä¿®äººå‘˜è´Ÿè´£å¯¹ç©ºè°ƒè¿›è¡Œä¿®ç†ã€‚ç®€åŒ–ï¼šç»´ä¿®äººå‘˜ä½¿ç”¨ä¿®ç†ç©ºè°ƒåŠŸèƒ½ã€‚"
    },
    {
      "id": "include-turn-on-ignition-uuid",
      "type": "Include",
      "sourceId": "uc-turn-on-ac-uuid",
      "targetId": "uc-ignition-uuid",
      "parentId": "pkg-car-ac-main-uuid",
      "description": "åŸæ–‡ï¼šå¼€å¯ç©ºè°ƒçš„æ“ä½œå¿…é¡»åŒ…å«æ‰“ç«å¯åŠ¨è¿™ä¸€å‰ç½®æ¡ä»¶ã€‚ç®€åŒ–ï¼šå¼€å¯ç©ºè°ƒä¹‹å‰å¿…é¡»å…ˆå®Œæˆæ‰“ç«å¯åŠ¨ï¼Œè¿™æ˜¯ä¸€ä¸ªå¿…è¦çš„å…¬å…±å‰ç½®æ­¥éª¤ã€‚"
    },
    {
      "id": "include-set-params-temp-uuid",
      "type": "Include",
      "sourceId": "uc-set-params-uuid",
      "targetId": "uc-set-temp-uuid",
      "parentId": "pkg-car-ac-main-uuid",
      "description": "åŸæ–‡ï¼šè®¾ç½®ç›¸å…³å‚æ•°ï¼Œå¦‚æ¸©åº¦ã€‚ç®€åŒ–ï¼šè®¾ç½®ç›¸å…³å‚æ•°åŒ…å«è®¾ç½®æ¸©åº¦è¿™ä¸€å…·ä½“æ“ä½œã€‚"
    },
    {
      "id": "include-set-params-direction-uuid",
      "type": "Include",
      "sourceId": "uc-set-params-uuid",
      "targetId": "uc-set-direction-uuid",
      "parentId": "pkg-car-ac-main-uuid",
      "description": "åŸæ–‡ï¼šè®¾ç½®ç›¸å…³å‚æ•°ï¼Œå¦‚é£å‘ã€‚ç®€åŒ–ï¼šè®¾ç½®ç›¸å…³å‚æ•°åŒ…å«è®¾ç½®é£å‘è¿™ä¸€å…·ä½“æ“ä½œã€‚"
    },
    {
      "id": "include-set-params-humidity-uuid",
      "type": "Include",
      "sourceId": "uc-set-params-uuid",
      "targetId": "uc-set-humidity-uuid",
      "parentId": "pkg-car-ac-main-uuid",
      "description": "åŸæ–‡ï¼šè®¾ç½®ç›¸å…³å‚æ•°ï¼Œå¦‚æ¹¿åº¦ã€‚ç®€åŒ–ï¼šè®¾ç½®ç›¸å…³å‚æ•°åŒ…å«è®¾ç½®æ¹¿åº¦è¿™ä¸€å…·ä½“æ“ä½œã€‚"
    },
    {
      "id": "extend-print-report-repair-uuid",
      "type": "Extend",
      "sourceId": "uc-print-report-uuid",
      "targetId": "uc-repair-ac-uuid",
      "parentId": "pkg-car-ac-main-uuid",
      "description": "åŸæ–‡ï¼šç»´ä¿®å®Œæ¯•åï¼Œç»´ä¿®äººå‘˜å¯ä»¥æ‰“å°ç»´ä¿®æŠ¥å‘Šã€‚ç®€åŒ–ï¼šæ‰“å°ç»´ä¿®æŠ¥å‘Šæ˜¯ä¿®ç†ç©ºè°ƒå®Œæˆåçš„å¯é€‰æ“ä½œï¼Œä¸ºä¿®ç†ç©ºè°ƒç”¨ä¾‹å¢åŠ äº†æ–‡æ¡£è®°å½•åŠŸèƒ½ã€‚"
    }
  ]
}
```

## è¾“å‡ºè¦æ±‚
- è¯·ä¸¥æ ¼æŒ‰ç…§ä¸Šè¿° JSON ç»“æ„è¾“å‡ºå®Œæ•´çš„ç”¨ä¾‹å›¾æ¨¡å‹ã€‚
- ç¡®ä¿æ‰€æœ‰ ID å¼•ç”¨çš„æ­£ç¡®æ€§å’Œä¸€è‡´æ€§ã€‚
- ç¡®ä¿æ¯ä¸ªå…ƒç´ éƒ½åŒ…å« `description` å­—æ®µï¼Œå†…å®¹ä¸æ¨ç†æ­¥éª¤ä¸€è‡´ã€‚
- ä¸è¦åœ¨ JSON ä¹‹å¤–æ·»åŠ ä»»ä½•è§£é‡Šæ€§æ–‡æœ¬ï¼ˆå¯ä»¥ç”¨ markdown ä»£ç å—åŒ…è£¹ JSONï¼‰ã€‚
- è¯·ä»…è¾“å‡º JSONï¼Œä¸è¦æ·»åŠ é¢å¤–çš„è¯´æ˜æˆ–æ³¨é‡Šã€‚
"""

# ==================== Pydantic æ¨¡å‹å®šä¹‰ ====================
class DiagramModel(BaseModel):
    id: str = Field(description="æ¨¡å‹å”¯ä¸€ID")
    name: str = Field(description="æ¨¡å‹åç§°")

class UseCaseDiagramOutput(BaseModel):
    model: List[DiagramModel] = Field(description="æ¨¡å‹åˆ—è¡¨")
    elements: List[Dict[str, Any]] = Field(description="å…ƒç´ åˆ—è¡¨ï¼ˆç”¨ä¾‹å›¾å…ƒç´ ï¼‰")

# ==================== è¾…åŠ©å‡½æ•° ====================

def get_usecase_output_dir() -> str:
    current_dir = os.path.dirname(os.path.abspath(__file__))
    project_root = os.path.dirname(os.path.dirname(os.path.dirname(current_dir)))
    output_dir = os.path.join(project_root, "data", "output", "usecase_diagrams")
    if not os.path.exists(output_dir):
        os.makedirs(output_dir, exist_ok=True)
        logger.info(f"åˆ›å»ºç”¨ä¾‹å›¾è¾“å‡ºç›®å½•: {output_dir}")
    return output_dir

def save_usecase_diagram(result: Dict[str, Any], task_id: str) -> str:
    try:
        output_dir = get_usecase_output_dir()
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        filename = f"usecase_diagram_{task_id}_{timestamp}.json"
        filepath = os.path.join(output_dir, filename)
        with open(filepath, "w", encoding="utf-8") as f:
            json.dump(result, f, ensure_ascii=False, indent=2)
        logger.info(f"âœ… ç”¨ä¾‹å›¾å·²ä¿å­˜åˆ°: {filepath}")
        return filepath
    except Exception as e:
        logger.error(f"ä¿å­˜ç”¨ä¾‹å›¾å¤±è´¥: {e}", exc_info=True)
        return ""

def validate_and_fix_json(json_str: str) -> Dict[str, Any]:
    """æ¸…ç†ä»£ç å—ï¼Œå°è¯•è§£æï¼Œå¤±è´¥åˆ™ç”¨ repair_json ä¿®å¤"""
    try:
        if "```json" in json_str:
            json_str = json_str.split("```json", 1)[1].split("```", 1)[0].strip()
        elif "```" in json_str:
            json_str = json_str.split("```", 1)[1].split("```", 1)[0].strip()
        json_str = re.sub(r'\\(?!["\\/bfnrtu])', r'\\\\', json_str)
        try:
            return json.loads(json_str)
        except json.JSONDecodeError as e:
            logger.warning(f"JSONè§£æå¤±è´¥ï¼Œå°è¯•ä¿®å¤: {e}")
            fixed = repair_json(json_str)
            return json.loads(fixed)
    except Exception as e:
        logger.error(f"æ— æ³•è§£ææˆ–ä¿®å¤JSON: {e}", exc_info=True)
        raise

def validate_descriptions(result: Dict[str, Any]) -> Dict[str, Any]:
    """ç¡®ä¿æ¯ä¸ªå…ƒç´ éƒ½æœ‰ description å­—æ®µï¼›è‹¥ç¼ºå¤±åˆ™è‡ªåŠ¨è¡¥å……ã€‚"""
    if not result or "elements" not in result:
        return result
    
    for elem in result.get("elements", []):
        elem_type = elem.get("type", "")
        elem_name = elem.get("name", "Unnamed")
        
        if "description" not in elem or not elem.get("description"):
            # æ ¹æ®ç±»å‹ç”Ÿæˆé»˜è®¤æè¿°
            if elem_type == "Package":
                elem["description"] = f"åŒ…ï¼š{elem_name}ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰"
            elif elem_type == "Actor":
                elem["description"] = f"å‚ä¸è€…ï¼š{elem_name}ï¼Œä¸ç³»ç»Ÿäº¤äº’çš„å¤–éƒ¨å®ä½“ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰"
            elif elem_type == "UseCase":
                elem["description"] = f"ç”¨ä¾‹ï¼š{elem_name}ï¼Œç³»ç»Ÿæä¾›çš„åŠŸèƒ½ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰"
            elif elem_type == "Association":
                source = elem.get("sourceId", "?")
                target = elem.get("targetId", "?")
                elem["description"] = f"å…³è”ï¼šå‚ä¸è€… {source} ä½¿ç”¨ç”¨ä¾‹ {target}ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰"
            elif elem_type == "Include":
                source = elem.get("sourceId", "?")
                target = elem.get("targetId", "?")
                elem["description"] = f"åŒ…å«ï¼šç”¨ä¾‹ {source} åŒ…å«ç”¨ä¾‹ {target}ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰"
            elif elem_type == "Extend":
                source = elem.get("sourceId", "?")
                target = elem.get("targetId", "?")
                elem["description"] = f"æ‰©å±•ï¼šç”¨ä¾‹ {source} æ‰©å±•ç”¨ä¾‹ {target}ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰"
            elif elem_type == "Generalization":
                source = elem.get("sourceId", "?")
                target = elem.get("targetId", "?")
                elem["description"] = f"æ³›åŒ–ï¼š{source} æ˜¯ {target} çš„ç‰¹åŒ–ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰"
            else:
                elem["description"] = f"{elem_type} å…ƒç´ ï¼š{elem_name}ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰"
            
            logger.warning(f"âš ï¸ è‡ªåŠ¨è¡¥å…… description: id={elem.get('id','unknown')} type={elem_type}")
    
    return result

# ==================== ä¸»å¤„ç†å‡½æ•° ====================

def process_usecase_task(state: WorkflowState, task_content: str) -> Dict[str, Any]:
    logger.info("ğŸ¯ å¼€å§‹å¤„ç†ç”¨ä¾‹å›¾ä»»åŠ¡")
    try:
        llm = ChatOpenAI(
            model=settings.llm_model,
            api_key=settings.openai_api_key,
            base_url=settings.base_url,
            temperature=0.0,
            streaming=True,
            max_tokens=getattr(settings, "max_tokens", 4096)
        )

        # ===== é˜¶æ®µ1ï¼šCoT æ¨ç† =====
        print(f"\n{'='*80}")
        print(f"ğŸ§  é˜¶æ®µ1: ç”¨ä¾‹å›¾åˆ†æä¸æ¨ç†")
        print(f"{'='*80}\n")
        
        cot_prompt = ChatPromptTemplate.from_messages([
            ("system", PROMPT_COT_SYSTEM),
            ("human", "è¾“å…¥ï¼š\n{task_content}\n\nè¾“å‡ºï¼šè¯·ä½ ä¸€æ­¥ä¸€æ­¥è¿›è¡Œæ¨ç†æ€è€ƒã€‚")
        ])
        cot_chain = cot_prompt | llm

        cot_result = ""
        for chunk in cot_chain.stream({"task_content": task_content}):
            chunk_content = getattr(chunk, "content", "")
            print(chunk_content, end="", flush=True)
            cot_result += chunk_content
        
        print(f"\n\n{'='*80}")
        print(f"âœ… æ¨ç†å®Œæˆ")
        print(f"{'='*80}\n")

        # ===== é˜¶æ®µ2ï¼šç”ŸæˆJSON =====
        print(f"\n{'='*80}")
        print(f"ğŸ“ é˜¶æ®µ2: ç”Ÿæˆç»“æ„åŒ–JSON (ç”¨ä¾‹å›¾)")
        print(f"{'='*80}\n")

        json_prompt = ChatPromptTemplate.from_messages([
            ("system", PROMPT_JSON_SYSTEM),
            ("human", "æ¨ç†ç»“æœï¼š\n{cot_result}\n\nè¯·ä¸¥æ ¼æŒ‰ç…§è§„åˆ™ç”ŸæˆJSONã€‚")
        ])
        json_chain = json_prompt | llm

        json_str = ""
        for chunk in json_chain.stream({"cot_result": cot_result}):
            chunk_content = getattr(chunk, "content", "")
            print(chunk_content, end="", flush=True)
            json_str += chunk_content

        print(f"\n\n{'='*80}")
        print(f"âœ… JSONç”Ÿæˆå®Œæˆ")
        print(f"{'='*80}\n")

        # è§£æã€ä¿®å¤å¹¶è¡¥å…¨description
        result = validate_and_fix_json(json_str)
        result = validate_descriptions(result)

        # å¯é€‰ï¼šç”¨Pydanticåšä¸€æ¬¡ä¸¥æ ¼æ ¡éªŒ
        try:
            validated = UseCaseDiagramOutput(**result)
            result = validated.dict()
            logger.info("âœ… Pydantic éªŒè¯é€šè¿‡ (ç”¨ä¾‹å›¾)")
        except Exception as e:
            logger.warning(f"âš ï¸ Pydantic éªŒè¯å¤±è´¥ (ç”¨ä¾‹å›¾)ï¼Œç»§ç»­ä½¿ç”¨ä¿®å¤åçš„JSON: {e}")

        logger.info("âœ… ç”¨ä¾‹å›¾ä»»åŠ¡å¤„ç†å®Œæˆ")
        return {"status": "success", "result": result}

    except Exception as e:
        logger.error(f"âŒ ç”¨ä¾‹å›¾ä»»åŠ¡å¤„ç†å¤±è´¥: {e}", exc_info=True)
        return {"status": "error", "message": str(e)}

def usecase_agent(state: WorkflowState, task_id: str, task_content: str) -> WorkflowState:
    logger.info(f"ç”¨ä¾‹å›¾Agentå¼€å§‹å¤„ç†ä»»åŠ¡ {task_id}")

    task_index = -1
    for i, task in enumerate(state.assigned_tasks):
        if task.id == task_id:
            task_index = i
            break

    if task_index == -1:
        logger.error(f"æ‰¾ä¸åˆ°ä»»åŠ¡ {task_id}")
        return state

    state.assigned_tasks[task_index].status = ProcessStatus.IN_PROGRESS

    try:
        result = process_usecase_task(state, task_content)
        if result.get("status") == "success":
            saved_path = save_usecase_diagram(result["result"], task_id)
            state.assigned_tasks[task_index].result = {**result["result"], "saved_file": saved_path}
            state.assigned_tasks[task_index].status = ProcessStatus.COMPLETED
            logger.info(f"âœ… ä»»åŠ¡ {task_id} å¤„ç†å®Œæˆ")
        else:
            state.assigned_tasks[task_index].status = ProcessStatus.FAILED
            state.assigned_tasks[task_index].error = result.get("message")
            logger.error(f"âŒ ä»»åŠ¡ {task_id} å¤„ç†å¤±è´¥: {result.get('message')}")
    except Exception as e:
        state.assigned_tasks[task_index].status = ProcessStatus.FAILED
        state.assigned_tasks[task_index].error = str(e)
        logger.error(f"ä»»åŠ¡ {task_id} å¼‚å¸¸: {e}", exc_info=True)

    return state